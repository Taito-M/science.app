<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>加速する電車の風船シミュレーター</title>
<style>
  :root{
    --bg:#eaf6ff; --panel:#ffffff; --ink:#0b1424; --muted:#4b5a77;
    --accent:#007aff; --accent2:#00c389; --line:#ccd9ee;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,"Noto Sans JP",sans-serif}
  header{position:sticky;top:0;z-index:10;padding:14px 18px;background:linear-gradient(180deg,#ffffffee,#ffffffcc);
          border-bottom:1px solid var(--line);backdrop-filter:saturate(120%) blur(6px)}
  header h1{margin:0;font-size:18px}
  header .sub{margin-top:4px;color:var(--muted);font-size:12px}
  main{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;padding:14px}
  @media (max-width:1000px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px #00000010}
  .pad{padding:14px}
  canvas{width:100%;height:420px;background:linear-gradient(180deg,#eaf6ff,#ffffff);border-radius:12px;display:block}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .control{display:flex;align-items:center;gap:10px}
  .control label{min-width:9em;color:var(--muted);font-size:12px}
  input[type="range"], select{width:100%}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:#f6fbff}
  button{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:8px 12px;font-weight:700;color:white;background:var(--accent)}
  button.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
  button.green{background:var(--accent2)}
  small{color:var(--muted)}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .dot{display:inline-flex;align-items:center;gap:6px}
  .dot::before{content:"";width:10px;height:10px;border-radius:50%}
  .dot.balloon::before{background:#ff6b6b}
  .dot.plumb::before{background:#007aff}
  .dot.geff::before{background:#00c389}
</style>
</head>
<body>
<header>
  <h1>加速する電車の風船シミュレーター</h1>
  <div class="sub">電車の加速度 <i>a</i> に対する「有効重力」<i>g<sub>eff</sub> = (−a, g)</i> を用いて、風船（浮力物体）が <i>−g<sub>eff</sub></i> 方向へ傾く様子を 2D で描画。動的応答は二次系（角度が目標角に緩和）で近似。</div>
</header>

<main>
  <section class="card pad">
    <canvas id="cv" width="1280" height="460"></canvas>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="legend">
        <span class="dot balloon">風船（ひも）</span>
        <span class="dot plumb">比較：おもり（糸）</span>
        <span class="dot geff">矢印：g<sub>eff</sub></span>
      </div>
      <div>
        <span class="pill">t=<span id="tval">0.00</span>s</span>
        <span class="pill">a=<span id="aval">0.00</span> m/s²</span>
        <span class="pill">|g<sub>eff</sub>|=<span id="geval">9.81</span> m/s²</span>
      </div>
    </div>
  </section>

  <aside class="card pad">
    <div class="grid cols-2">
      <div class="control"><label>加速度プロファイル</label>
        <select id="profile">
          <option value="const">一定加速</option>
          <option value="step">ステップ（t≥t₀で加速）</option>
          <option value="sin">正弦（往復）</option>
          <option value="brake">加速→等速→減速</option>
        </select>
      </div>
      <div class="control"><label>天井から手までの長さ L（m）</label><input type="range" id="L" min="0.3" max="2.0" step="0.01" value="1.0"><span class="pill" id="Lval">1.00</span></div>
      <div class="control"><label>基準加速度 a₀（m/s²）</label><input type="range" id="a0" min="-3" max="3" step="0.01" value="1.0"><span class="pill" id="a0val">1.00</span></div>
      <div class="control"><label>ステップ時刻 t₀（s）</label><input type="range" id="t0" min="0" max="5" step="0.01" value="1.0"><span class="pill" id="t0val">1.00</span></div>
      <div class="control"><label>正弦：周波数 f（Hz）</label><input type="range" id="freq" min="0" max="1" step="0.01" value="0.20"><span class="pill" id="freqval">0.20</span></div>
      <div class="control"><label>減衰比 ζ</label><input type="range" id="zeta" min="0" max="1" step="0.01" value="0.30"><span class="pill" id="zetaval">0.30</span></div>
    </div>

    <div class="row" style="margin-top:6px">
      <label class="pill"><input id="showPlumb" type="checkbox" checked> 比較ペンデュラムを表示</label>
      <label class="pill"><input id="showGeff" type="checkbox" checked> g<sub>eff</sub> 矢印を表示</label>
      <label class="pill"><input id="pause" type="checkbox"> 一時停止</label>
      <button id="reset" class="ghost">↺ リセット</button>
    </div>
    <small>物理モデル：非慣性系での有効重力 g<sub>eff</sub>=(−a, g)。風船のひも角度 θ は目標角 θ*（= g<sub>eff</sub> と反対方向）に対し、二次系 θ¨ = −ω₀² sin(θ−θ*) − 2ζω₀ θ˙ で近似。比較用のおもりは θ* = g<sub>eff</sub> と同方向。</small>
  </aside>
</main>

<script>
(function(){
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const $ = id=>document.getElementById(id);

  // World params
  const g = 9.81; // m/s^2
  let t = 0;
  let last = performance.now();

  // State
  const state = {
    L: 1.0, a0: 1.0, t0: 1.0, freq: 0.2,
    zeta: 0.3,
    showPlumb: true,
    showGeff: true,
    pause: false,
    profile: 'const',
    // angles measured from vertical downward, + to the right
    thetaBalloon: 0, omegaBalloon: 0,
    thetaPlumb: 0, omegaPlumb: 0
  };

  // UI bindings
  const bind = (id, fmt, on)=>{ const el=$(id), lab=$(id+"val"); const up=()=>{const v=parseFloat(el.value); lab.textContent=fmt(v); on(v);} ; el.addEventListener('input',up); up(); };
  bind('L', v=>v.toFixed(2), v=>state.L=v);
  bind('a0', v=>v.toFixed(2), v=>state.a0=v);
  bind('t0', v=>v.toFixed(2), v=>state.t0=v);
  bind('freq', v=>v.toFixed(2), v=>state.freq=v);
  bind('zeta', v=>v.toFixed(2), v=>state.zeta=v);
  $('profile').addEventListener('change', e=>state.profile=e.target.value);
  $('showPlumb').onchange = e=>state.showPlumb=e.target.checked;
  $('showGeff').onchange = e=>state.showGeff=e.target.checked;
  $('pause').onchange = e=>state.pause=e.target.checked;
  $('reset').onclick = ()=>{ t=0; state.thetaBalloon=state.omegaBalloon=0; state.thetaPlumb=state.omegaPlumb=0; };

  // Acceleration profile (train acceleration to +x is forward)
  function axAtTime(t){
    const a0 = state.a0;
    switch(state.profile){
      case 'const': return a0;
      case 'step': return (t>=state.t0? a0: 0);
      case 'sin': return a0 * Math.sin(2*Math.PI*state.freq*t);
      case 'brake': {
        // accelerate a0 for 2s, coast 2s, brake -a0 for 2s, then repeat
        const T=6; const tau = ((t % T)+T)%T; if(tau<2) return a0; if(tau<4) return 0; return -a0;
      }
      default: return a0;
    }
  }

  // Draw helper
  function arrow(x,y,dx,dy,color){
    const len = Math.hypot(dx,dy) || 1; const ux=dx/len, uy=dy/len; const size=10;
    ctx.strokeStyle=color; ctx.fillStyle=color; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+dx,y+dy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x+dx,y+dy); ctx.lineTo(x+dx - ux*size - uy*size*0.6, y+dy - uy*size + ux*size*0.6);
    ctx.lineTo(x+dx - ux*size + uy*size*0.6, y+dy - uy*size - ux*size*0.6); ctx.closePath(); ctx.fill();
  }

  // Integrator (semi-implicit Euler)
  function step(dt){
    const ax = axAtTime(t);
    const geffX = -ax, geffY = g; // effective gravity (points where mass would "fall")
    const geffMag = Math.hypot(geffX, geffY);

    // Target directions
    const thetaGeff = Math.atan2(geffX, geffY); // from vertical down
    const thetaTargetPlumb = thetaGeff;           // plumb aligns with geff
    const thetaTargetBalloon = thetaGeff + Math.PI; // balloon aligns opposite geff (upwards)

    // natural frequency based on |geff| and length
    const w0 = Math.sqrt(geffMag / Math.max(0.05, state.L));
    const z = state.zeta;

    // dynamics: theta¨ = -w0^2 * sin(theta - theta*) - 2 z w0 theta˙
    const fBall = -w0*w0 * Math.sin(state.thetaBalloon - thetaTargetBalloon) - 2*z*w0*state.omegaBalloon;
    const fPlum = -w0*w0 * Math.sin(state.thetaPlumb - thetaTargetPlumb) - 2*z*w0*state.omegaPlumb;

    state.omegaBalloon += fBall * dt; state.thetaBalloon += state.omegaBalloon * dt;
    state.omegaPlumb += fPlum * dt;   state.thetaPlumb += state.omegaPlumb * dt;

    // UI readouts
    $('tval').textContent = t.toFixed(2);
    $('aval').textContent = ax.toFixed(2);
    $('geval').textContent = geffMag.toFixed(2);
  }

  // Rendering scene
  function draw(){
    const w = cv.width, h = cv.height;
    ctx.clearRect(0,0,w,h);

    // Train interior
    const pad = 40; const carH = h-120; const carY = 60; const carR = 16;
    ctx.fillStyle = '#ffffff'; ctx.strokeStyle = '#ccd9ee'; ctx.lineWidth=2;
    roundRect(ctx, pad, carY, w-2*pad, carH, carR, true, true);
    // floor lines
    ctx.strokeStyle = '#e6effb'; ctx.lineWidth=1; ctx.beginPath();
    for(let x=pad+40; x<w-60; x+=40){ ctx.moveTo(x,carY+carH-20); ctx.lineTo(x,carY+carH-10); }
    ctx.stroke();

    // Person & anchor point
    const px = w*0.35, py = carY+carH-20; // feet
    drawPerson(px, py);
    const anchor = {x: px+20, y: py-140}; // hand anchor near shoulder

    // Scale meters to pixels
    const m2px = 180; // 1 m = 180 px

    // Balloon
    const Lpx = state.L * m2px;
    const bx = anchor.x + Lpx * Math.sin(state.thetaBalloon);
    const by = anchor.y + Lpx * Math.cos(state.thetaBalloon);

    // String
    ctx.strokeStyle = '#ff6b6b'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(anchor.x, anchor.y); ctx.lineTo(bx, by); ctx.stroke();
    // Balloon body
    ctx.fillStyle = '#ffe3e3'; ctx.strokeStyle = '#ff6b6b'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.ellipse(bx, by-14, 18, 24, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    // Knot
    ctx.beginPath(); ctx.moveTo(bx-4, by-2); ctx.lineTo(bx+4, by-2); ctx.lineTo(bx, by+4); ctx.closePath(); ctx.fill();

    // Optional plumb bob for comparison
    if(state.showPlumb){
      const px2 = anchor.x - 140, py2 = anchor.y;
      const pbx = px2 + Lpx * Math.sin(state.thetaPlumb);
      const pby = py2 + Lpx * Math.cos(state.thetaPlumb);
      ctx.strokeStyle = '#007aff'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(px2, py2); ctx.lineTo(pbx, pby); ctx.stroke();
      ctx.fillStyle = '#e3f0ff'; ctx.strokeStyle = '#007aff'; ctx.beginPath(); ctx.arc(pbx, pby+8, 10, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    }

    // geff arrow
    if(state.showGeff){
      const ax = axAtTime(t); const geffX = -ax, geffY = g; const s = 30; // scale for drawing
      const vlen = Math.hypot(geffX, geffY);
      const vx = (geffX/vlen) * 120, vy=(geffY/vlen) * 120;
      arrow(anchor.x, anchor.y, vx, vy, '#00c389');
      // label
      ctx.fillStyle = '#007a4a'; ctx.font='12px ui-sans-serif'; ctx.fillText('g_eff', anchor.x+vx+6, anchor.y+vy+4);
      // and for balloon "up" arrow (opposite)
      arrow(anchor.x, anchor.y, -vx*0.7, -vy*0.7, '#ff6b6b44');
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); if(fill) ctx.fill(); if(stroke) ctx.stroke();
  }

  function drawPerson(x,y){
    ctx.strokeStyle = '#4b5a77'; ctx.lineWidth=3; ctx.lineCap='round';
    // body
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y-80); ctx.stroke();
    // legs
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x-14,y-10); ctx.moveTo(x,y); ctx.lineTo(x+14,y-10); ctx.stroke();
    // head
    ctx.fillStyle = '#ffd9b3'; ctx.beginPath(); ctx.arc(x,y-96,12,0,Math.PI*2); ctx.fill();
    // arm holding
    ctx.beginPath(); ctx.moveTo(x,y-60); ctx.lineTo(x+20,y-40); ctx.stroke();
    // windows
    const y0 = y-120; ctx.fillStyle='#eaf6ff'; ctx.strokeStyle='#ccd9ee'; for(let i=0;i<4;i++){ const wx= x+80 + i*90; ctx.fillRect(wx, y0, 70, 46); ctx.strokeRect(wx, y0, 70, 46);}  
  }

  // Main loop
  function loop(now){
    const dt = Math.min(0.05, (now-last)/1000); last = now; if(!state.pause) { step(dt); t += dt; }
    draw(); requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>