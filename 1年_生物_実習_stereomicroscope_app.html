<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>双眼実体顕微鏡 学習アプリ</title>
<style>
  :root{
    --bg:#f7fafc;
    --card:#ffffff;
    --ink:#1a202c;
    --muted:#4a5568;
    --accent:#2563eb;
    --ok:#16a34a;
    --bad:#dc2626;
    --gold:#d97706;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","游ゴシック体","Yu Gothic", "Noto Sans JP", "Meiryo", sans-serif;
    color:var(--ink);
    background:var(--bg);
    line-height:1.6;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,#ffffffcc,#ffffffcc), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><rect width="8" height="8" fill="white"/><path d="M0 8 L8 0" stroke="%23e2e8f0" /></svg>');
    backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid #e2e8f0;
  }
  .bar{
    max-width:1100px; margin:0 auto; padding:10px 16px;
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
  }
  h1{font-size:clamp(18px,3.2vw,24px); margin:0; font-weight:700}
  .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .meta input[type="text"]{
    padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px;
    min-width:180px; background:#fff;
  }
  .btn{
    border:1px solid #cbd5e1; background:#fff; color:var(--ink);
    border-radius:10px; padding:8px 12px; cursor:pointer;
    transition:transform .05s ease, box-shadow .2s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent); color:#fff; border-color:transparent}
  .btn.good{background:var(--ok); color:#fff; border-color:transparent}
  .btn.warn{background:var(--gold); color:#fff; border-color:transparent}
  .btn.ghost{background:transparent}
  .tabs{max-width:1100px; margin:14px auto; padding:0 16px}
  .tabbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
  .tabbar button{
    background:#fff; border:1px solid #cbd5e1; color:var(--muted);
    padding:10px 12px; border-radius:999px; cursor:pointer;
  }
  .tabbar button.active{background:var(--accent); color:#fff; border-color:transparent}
  .card{background:var(--card); border:1px solid #e2e8f0; border-radius:14px; padding:16px}
  .grid{display:grid; gap:16px}
  @media(min-width:950px){ .grid.two{grid-template-columns:1.2fr 1fr} }
  .diagram{
    width:100%; height:auto; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:12px; padding:8px;
  }
  .legend{display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:14px}
  .pill{border-radius:999px; padding:4px 10px; background:#eef2ff; border:1px solid #c7d2fe}
  .hotspot{cursor:pointer; transition:transform .15s ease}
  .hotspot:hover{transform:scale(1.05)}
  .hint{font-size:14px; color:var(--muted)}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .q{padding:12px; border:1px solid #e2e8f0; border-radius:12px; margin-bottom:8px}
  .q h4{margin:0 0 8px 0}
  .opt{display:block; margin:.35rem 0; padding:.35rem .5rem; border-radius:8px; border:1px solid #e2e8f0; background:#fff; cursor:pointer}
  .opt input{margin-right:.5rem}
  .score{font-weight:700}
  .tag{display:inline-block; border:1px solid #cbd5e1; padding:3px 8px; border-radius:999px; font-size:12px; color:var(--muted)}
  .footer{max-width:1100px; margin:20px auto; padding:0 16px 30px; color:var(--muted); font-size:13px}
  details summary{cursor:pointer}
  .toast{position:fixed; bottom:16px; right:16px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.25); display:none}
  .sr{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
</style>
</head>
<body>
<header>
  <div class="bar">
    <h1>双眼実体顕微鏡 学習アプリ</h1>
    <div class="meta">
      <input id="studentName" type="text" placeholder="名前を入力">
      <button class="btn primary" id="lockIn">開始</button>
      <button class="btn ghost" id="toggleLang" aria-pressed="false">英語も表示</button>
      <button class="btn ghost" id="teacherModeBtn" aria-pressed="false">先生モード</button>
    </div>
  </div>
</header>

<main class="tabs">
  <nav class="tabbar" role="tablist" aria-label="学習モード">
    <button role="tab" aria-selected="true" id="tab-learn" class="active" data-tab="learn">① 学ぶ</button>
    <button role="tab" aria-selected="false" id="tab-practice" data-tab="practice" disabled>② 練習（指さし）</button>
    <button role="tab" aria-selected="false" id="tab-quiz" data-tab="quiz" disabled>③ 小テスト</button>
    <button role="tab" aria-selected="false" id="tab-steps" data-tab="steps" disabled>④ 使い方手順</button>
    <button role="tab" aria-selected="false" id="tab-admin" data-tab="admin" hidden>教師</button>
  </nav>

  <!-- Learn -->
  <section id="panel-learn" class="card grid two" role="tabpanel" aria-labelledby="tab-learn">
    <div>
      <div class="legend">
        <span class="pill">図をタップで名称と説明</span>
        <span class="pill">ピン＝部位</span>
        <span class="pill">上ライト＝落射 / 下ライト＝透過</span>
      </div>
      <svg id="microscopeSVG" class="diagram" viewBox="0 0 700 700" aria-label="実体顕微鏡 図">
        <!-- Simple stylized stereomicroscope -->
        <defs>
          <filter id="shadow"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.2"/></filter>
        </defs>
        <!-- base -->
        <rect x="190" y="590" width="320" height="40" rx="10" fill="#e5e7eb" stroke="#cbd5e1"></rect>
        <rect x="210" y="520" width="280" height="80" rx="14" fill="#f1f5f9" stroke="#cbd5e1"></rect>
        <!-- stage plate -->
        <rect x="230" y="480" width="240" height="24" rx="10" fill="#ffffff" stroke="#94a3b8" filter="url(#shadow)"></rect>
        <!-- stage clips -->
        <rect x="255" y="470" width="30" height="10" rx="2" fill="#94a3b8"></rect>
        <rect x="415" y="470" width="30" height="10" rx="2" fill="#94a3b8"></rect>
        <!-- pillar/arm -->
        <rect x="450" y="260" width="20" height="220" rx="8" fill="#cbd5e1"></rect>
        <rect x="310" y="260" width="160" height="30" rx="10" fill="#e5e7eb"></rect>
        <!-- head/body -->
        <rect x="270" y="200" width="200" height="70" rx="16" fill="#e5e7eb" stroke="#cbd5e1"></rect>
        <!-- eyepiece tubes -->
        <rect x="290" y="170" width="60" height="40" rx="10" fill="#d1d5db" stroke="#9ca3af"></rect>
        <rect x="380" y="170" width="60" height="40" rx="10" fill="#d1d5db" stroke="#9ca3af"></rect>
        <!-- eyepieces -->
        <rect x="300" y="150" width="40" height="22" rx="8" fill="#111827"></rect>
        <rect x="390" y="150" width="40" height="22" rx="8" fill="#111827"></rect>
        <!-- zoom knob -->
        <circle cx="470" cy="230" r="18" fill="#94a3b8" stroke="#64748b"></circle>
        <!-- focus knob -->
        <circle cx="470" cy="340" r="30" fill="#94a3b8" stroke="#64748b"></circle>
        <!-- lights -->
        <circle cx="250" cy="540" r="12" fill="#fde68a" stroke="#f59e0b"></circle>
        <circle cx="410" cy="540" r="12" fill="#bfdbfe" stroke="#60a5fa"></circle>
        <!-- labels/hotspots added by JS -->
      </svg>
      <p class="hint">ヒント：英語表記は右上の「英語も表示」で切り替えできます。</p>
      <div id="infoBox" class="card" style="margin-top:10px">
        <strong>部位説明</strong>
        <div id="partInfo">図のピンをタップすると、ここに説明が表示されます。</div>
      </div>
    </div>
    <aside>
      <div class="card">
        <h3>観察のコツ</h3>
        <ul>
          <li>まずは<strong>最低倍率</strong>から。視野が広く、ピント合わせが簡単です。</li>
          <li><strong>眼幅調整</strong>で左右の視野を一つに重ねます。</li>
          <li><strong>視度調整リング</strong>で左右の目の差を補正します。</li>
          <li><strong>光量</strong>は低めから。明るすぎるとコントラストが落ちます。</li>
          <li><strong>落射照明</strong>は不透明なもの、<strong>透過照明</strong>は薄い透明なものに◎</li>
          <li>持ち運ぶときは<strong>両手</strong>で（アーム＋台座）。</li>
        </ul>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>言葉（和英）</h3>
        <ul id="glossary"></ul>
      </div>
    </aside>
  </section>

  <!-- Practice -->
  <section id="panel-practice" class="card grid two" role="tabpanel" aria-labelledby="tab-practice" hidden>
    <div>
      <div class="row">
        <span class="pill">問題：<span id="practicePrompt">—</span></span>
        <button class="btn" id="nextPractice">次の問題</button>
      </div>
      <svg id="practiceSVG" class="diagram" viewBox="0 0 700 700" aria-label="練習 図"></svg>
      <p class="hint">指示された部位を図から<strong>タップ</strong>してください。</p>
      <div class="row">
        <span class="score">正解：<span id="practiceCorrect">0</span> / <span id="practiceTotal">0</span></span>
        <button class="btn good" id="resetPractice">リセット</button>
      </div>
    </div>
    <aside class="card">
      <h3>学習目標</h3>
      <p>全14部位を3回連続で正解できたら合格！</p>
      <ul>
        <li>場所を<strong>見て覚える</strong></li>
        <li>名前と<strong>機能</strong>を結びつける</li>
      </ul>
    </aside>
  </section>

  <!-- Quiz -->
  <section id="panel-quiz" class="card" role="tabpanel" aria-labelledby="tab-quiz" hidden>
    <div class="row" style="justify-content:space-between; align-items:center">
      <div>
        <span class="tag">10問</span>
        <span class="tag">選択式＋指さし混合</span>
      </div>
      <div class="row">
        <button class="btn" id="genQuiz">新しいテスト</button>
        <button class="btn primary" id="submitQuiz">採点する</button>
      </div>
    </div>
    <div id="quizArea"></div>
    <div id="quizResult" class="card" style="margin-top:10px; display:none">
      <h3>結果</h3>
      <p class="score">スコア：<span id="quizScore">0</span> 点（100点満点）</p>
      <p>フィードバック：<span id="quizFeedback">—</span></p>
    </div>
  </section>

  <!-- Steps -->
  <section id="panel-steps" class="card grid two" role="tabpanel" aria-labelledby="tab-steps" hidden>
    <div>
      <h3>正しい使い方（手順）</h3>
      <ol id="stepsList">
        <!-- populated by JS -->
      </ol>
      <details style="margin-top:8px">
        <summary>ポイント（安全・片付け）</summary>
        <ul>
          <li>レンズはレンズ紙で軽く拭く。<strong>ティッシュ不可</strong>。</li>
          <li>倍率は下げ、光量はゼロ、電源OFF、ダストカバー。</li>
          <li>コードを本体に巻き付けない（断線防止）。</li>
        </ul>
      </details>
    </div>
    <aside>
      <h3>手順並べ替え練習</h3>
      <p class="hint">各行をタップして選択し、上下の矢印で順番を整えよう。</p>
      <div id="orderGame" class="card"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="shuffleSteps">シャッフル</button>
        <button class="btn primary" id="checkOrder">採点</button>
      </div>
      <p class="score">正解率：<span id="orderScore">0</span>%</p>
    </aside>
  </section>

  <!-- Admin -->
  <section id="panel-admin" class="card" role="tabpanel" aria-labelledby="tab-admin" hidden>
    <h3>先生モード</h3>
    <div class="row">
      <input id="pin" type="text" placeholder="PIN（初期値: 0000）" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px">
      <button class="btn" id="enterPin">開く</button>
      <button class="btn warn" id="resetAll">データ初期化</button>
      <button class="btn" id="exportCSV">CSVダウンロード</button>
    </div>
    <p class="hint">このPCのブラウザに保存された学習・テスト結果をCSVで出力します（UTF-8 BOM付 / Excelで文字化けしません）。</p>
    <div id="adminTable"></div>
  </section>

</main>

<div class="footer">
  <details>
    <summary>このアプリについて（オフライン対応）</summary>
    <p>このファイル1つで動作します。インターネット不要。ファイル名はお好みで変更可。<br>iPad / iPhone でもSafariで動作します。</p>
  </details>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
// ====== Data ======
const PARTS = [
  {id:'eyepieceL', jp:'接眼レンズ（左）', en:'Eyepiece (Left)', x:320, y:160, r:14, info:'目を当てるレンズ。像を拡大して目に届けます。視度調整リングで焦点差を補正できます。'},
  {id:'eyepieceR', jp:'接眼レンズ（右）', en:'Eyepiece (Right)', x:410, y:160, r:14, info:'目を当てるレンズ。左右で見え方が違うときは視度調整を。'},
  {id:'ipd', jp:'眼幅調整', en:'Interpupillary Distance', x:370, y:185, r:14, info:'両眼の距離に合わせて鏡筒の幅を調整。左右の視野が1つに重なるようにします。'},
  {id:'diopter', jp:'視度調整リング', en:'Diopter Ring', x:300, y:185, r:14, info:'左右の目の焦点差を補正するリング。片目ずつピントを合わせて調整します。'},
  {id:'head', jp:'鏡筒（ヘッド）', en:'Binocular Head', x:320, y:220, r:16, info:'左右の光学系を内蔵する部分。ズーム機構につながっています。'},
  {id:'zoom', jp:'倍率切換え（ズーム）', en:'Zoom Knob', x:470, y:230, r:16, info:'倍率を連続的に変えるノブ。観察開始時は最低倍率から。高倍率では暗く・ボケやすいので注意。'},
  {id:'focus', jp:'フォーカスつまみ', en:'Focus Knob', x:470, y:340, r:20, info:'鏡筒の上下でピントを合わせます（実体顕微鏡は通常粗動のみ）。'},
  {id:'arm', jp:'支柱／アーム', en:'Arm / Pillar', x:460, y:300, r:14, info:'本体を支える柱。持ち運ぶときはアームと台座を両手で持ちます。'},
  {id:'stage', jp:'ステージ（作業台）', en:'Stage Plate', x:350, y:490, r:16, info:'標本を置く台。白板／黒板の切替プレートがある機種も。中央が明るいときは透過照明です。'},
  {id:'clips', jp:'試料押さえ（クリップ）', en:'Stage Clips', x:270, y:470, r:12, info:'標本を固定します。強く押し付けすぎないように注意。'},
  {id:'topLight', jp:'落射照明（上部ライト）', en:'Incident Light (Top)', x:250, y:540, r:14, info:'上から照らすライト。コイン・昆虫など不透明なものの表面観察に。'},
  {id:'bottomLight', jp:'透過照明（下部ライト）', en:'Transmitted Light (Bottom)', x:410, y:540, r:14, info:'下から照らすライト。葉・薄いフィルムなど半透明試料に。'},
  {id:'power', jp:'電源スイッチ', en:'Power Switch', x:215, y:545, r:12, info:'照明のON/OFF。はじめはOFFでコード接続→光量低めでONが基本。'},
  {id:'dim', jp:'光量調整つまみ', en:'Brightness Control', x:470, y:545, r:12, info:'明るさを調整。明るすぎると白っぽくなるので必要最小限に。'},
  {id:'base', jp:'鏡基（台座）', en:'Base', x:350, y:600, r:18, info:'本体の土台。持ち運び時はアームと一緒にしっかり持ちます。'}
];

const STEPS = [
  '安定した机に本体を置き、周囲を片付ける。',
  '電源コードを確認し、<strong>スイッチOFF</strong>のまま接続。',
  'ステージ中央に標本を置き、必要なら白/黒プレートを選ぶ。',
  '眼幅調整で左右の視野を1つに重ねる。',
  '視度調整リングで左右の焦点差を補正する。',
  '照明をON（光量は低めから）。',
  '倍率を<strong>最低倍率</strong>にして観察開始。',
  'フォーカスつまみでピントを合わせる。',
  '必要に応じて倍率を上げ、再度ピントを合わせる。',
  '観察後：倍率を下げ、光量ゼロ→電源OFF→カバーをかける。',
  '移動時：アームと台座を<strong>両手</strong>で持つ。'
];

const MC_BANK = [
  {t:'観察を始めるときの倍率として正しいのはどれ？', choices:['最高倍率','最低倍率','いつも同じ倍率（中）'], a:1, exp:'視野が広くピントが合いやすい最低倍率から始めます。'},
  {t:'眼幅調整の目的は？', choices:['左右の視野を1つに重ねるため','像をさらに拡大するため','光量を増やすため'], a:0, exp:'両眼の距離に合わせ、円が1つに見えるようにします。'},
  {t:'視度調整リングは何を補正する？', choices:['左右の目の焦点差','倍率の段数','光量のばらつき'], a:0, exp:'左右の視力差（焦点差）を補正します。'},
  {t:'落射照明（上部ライト）に適した試料は？', choices:['透明な薄い葉','コインなど不透明なもの','プレパラートの微生物'], a:1, exp:'不透明試料の表面観察に向きます。'},
  {t:'透過照明（下部ライト）が向くのは？', choices:['厚い石','コイン','薄い透明試料'], a:2, exp:'薄い透明・半透明の試料向けです。'},
  {t:'観察後の正しい片付けは？', choices:['光量MAXのまま電源OFF','倍率を下げて光量ゼロ→電源OFF','倍率MAXで電源OFF'], a:1, exp:'次の人が使いやすい基本動作です。'},
  {t:'持ち運びで安全なのは？', choices:['片手でアームだけ持つ','両手でアームと台座を持つ','台座だけ持つ'], a:1, exp:'必ず両手で支えます。'},
  {t:'フォーカスつまみの役割は？', choices:['鏡筒を上下してピント合わせ','光量調整','倍率連続変更'], a:0, exp:'ピント合わせ専用です。'},
  {t:'ズームノブの正しい使い方は？', choices:['最初から高倍率にして細部を見る','観察しながら必要に応じて倍率を上げる','常に同じ倍率で固定'], a:1, exp:'まず低倍率→必要に応じて上げます。'},
  {t:'視度調整はどのように行う？', choices:['両目で同時に回す','片目ずつピントを合わせ差をリングで補正','順番は関係ない'], a:1, exp:'片目ずつピント→リングで差を消します。'}
];

// ====== Utilities ======
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

function toast(msg){ const t = $('#toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }

function nowJP(){
  try{
    return new Date().toLocaleString('ja-JP', {hour12:false});
  }catch(e){ return new Date().toISOString(); }
}

// Local storage helpers
const KEY_RESULTS='stereo_results_v1';
function loadResults(){ try{ return JSON.parse(localStorage.getItem(KEY_RESULTS) || '[]'); }catch(e){ return []; } }
function saveResult(rec){
  const arr = loadResults();
  arr.push(rec);
  localStorage.setItem(KEY_RESULTS, JSON.stringify(arr));
}

// ====== Tabs / gating ======
const tabs = ['learn','practice','quiz','steps','admin'];
tabs.forEach(id=>{
  $('#tab-'+id)?.addEventListener('click', ()=>showTab(id));
});

function showTab(id){
  tabs.forEach(t=>{
    $('#panel-'+t)?.setAttribute('hidden','');
    $('#tab-'+t)?.classList.remove('active');
    $('#tab-'+t)?.setAttribute('aria-selected','false');
  });
  $('#panel-'+id)?.removeAttribute('hidden');
  $('#tab-'+id)?.classList.add('active');
  $('#tab-'+id)?.setAttribute('aria-selected','true');
}

$('#lockIn').addEventListener('click', ()=>{
  const name = $('#studentName').value.trim();
  if(!name){ toast('名前を入力してください'); return; }
  // unlock tabs
  ['practice','quiz','steps'].forEach(t=>{
    $('#tab-'+t).disabled=false;
  });
  toast('準備OK。学習を始めましょう！');
});

// Language toggle
let showEN=false;
$('#toggleLang').addEventListener('click', (e)=>{
  showEN = !showEN;
  e.currentTarget.setAttribute('aria-pressed', String(showEN));
  e.currentTarget.textContent = showEN ? '日本語のみ' : '英語も表示';
  renderGlossary();
  renderHotspots();
  renderPractice();
});

// Teacher mode
let adminOpen=false;
$('#teacherModeBtn').addEventListener('click', ()=>{
  showTab('admin');
});
$('#enterPin').addEventListener('click', ()=>{
  const pin = $('#pin').value.trim();
  if(pin==='0000' || pin==='2468' || pin==='1357'){
    adminOpen=true;
    $('#tab-admin').hidden=false;
    renderAdmin();
    toast('先生モードを開きました');
  }else{
    adminOpen=false;
    $('#tab-admin').hidden=true;
    toast('PINが違います');
  }
});

$('#resetAll').addEventListener('click', ()=>{
  if(confirm('本当にこのブラウザ内の学習/テスト結果を消去しますか？')){
    localStorage.removeItem(KEY_RESULTS);
    renderAdmin();
    toast('データを初期化しました');
  }
});

$('#exportCSV').addEventListener('click', ()=>{
  const rows = loadResults();
  const headers = ['日時','氏名','種別','詳細','得点'];
  const bom = '\\ufeff'; // UTF-8 BOM for Excel
  const lines = [headers.join(',')];
  for(const r of rows){
    const line = [r.time, r.name, r.type, (r.detail||'').replace(/\\n/g,' '), r.score??''].map(s=>`"${String(s).replace(/"/g,'""')}"`).join(',');
    lines.push(line);
  }
  const blob = new Blob([bom + lines.join('\\r\\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'stereomicroscope_results.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  toast('CSVをダウンロードしました');
});

function renderAdmin(){
  const rows = loadResults().slice().reverse();
  const wrap = $('#adminTable');
  if(!rows.length){ wrap.innerHTML = '<p class="hint">保存データはありません。</p>'; return; }
  const html = [`<div style="overflow:auto"><table style="min-width:700px; border-collapse:collapse">`,
    `<thead><tr style="background:#f1f5f9"><th style="border:1px solid #e2e8f0; padding:6px 8px">日時</th><th style="border:1px solid #e2e8f0; padding:6px 8px">氏名</th><th style="border:1px solid #e2e8f0; padding:6px 8px">種別</th><th style="border:1px solid #e2e8f0; padding:6px 8px">得点</th><th style="border:1px solid #e2e8f0; padding:6px 8px">詳細</th></tr></thead><tbody>`];
  for(const r of rows){
    html.push(`<tr>
      <td style="border:1px solid #e2e8f0; padding:6px 8px; white-space:nowrap">${r.time}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${r.name||''}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${r.type}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${r.score??''}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${(r.detail||'').replace(/\\n/g,'<br>')}</td>
    </tr>`);
  }
  html.push('</tbody></table></div>');
  wrap.innerHTML = html.join('');
}

// ====== Learn: hotspots on main SVG ======
function renderHotspots(){
  const svg = $('#microscopeSVG');
  // remove old hotspots
  $$('.hotspot', svg).forEach(n=>n.remove());
  // add new
  for(const p of PARTS){
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.classList.add('hotspot');
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx', p.x); c.setAttribute('cy', p.y); c.setAttribute('r', p.r);
    c.setAttribute('fill', 'rgba(37,99,235,.15)'); c.setAttribute('stroke', '#2563eb'); c.setAttribute('stroke-width','2');
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', p.x); t.setAttribute('y', p.y - (p.r+6));
    t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','12');
    t.setAttribute('fill','#111827'); t.textContent = showEN ? `${p.jp} / ${p.en}` : p.jp;
    t.setAttribute('pointer-events','none');
    g.appendChild(c); g.appendChild(t);
    g.addEventListener('click', ()=>showPartInfo(p));
    svg.appendChild(g);
  }
}

function showPartInfo(p){
  $('#partInfo').innerHTML = `<div><strong>${p.jp}${showEN? ' / '+p.en:''}</strong><br>${p.info}</div>`;
}

// glossary
function renderGlossary(){
  const ul = $('#glossary'); ul.innerHTML='';
  PARTS.forEach(p=>{
    const li = document.createElement('li');
    li.innerHTML = showEN ? `<strong>${p.jp}</strong> — ${p.en}` : `<strong>${p.jp}</strong>`;
    ul.appendChild(li);
  });
}

// ====== Practice: point the part ======
let practiceIndex=0, practiceCorrect=0, practiceTotal=0;
function renderPractice(){
  const svg = $('#practiceSVG');
  svg.innerHTML = $('#microscopeSVG').innerHTML; // reuse drawing
  // keep only base artwork + add minimal pins (no text)
  $$('.hotspot text', svg).forEach(n=>n.remove());
  // attach click handlers
  $$('.hotspot', svg).forEach((g,i)=>{
    const part = PARTS[i];
    g.addEventListener('click', ()=>{
      practiceTotal++;
      const want = PARTS[practiceIndex];
      const cx = +$('circle', g).getAttribute('cx');
      const cy = +$('circle', g).getAttribute('cy');
      const dx = cx - want.x, dy = cy - want.y;
      const ok = Math.hypot(dx,dy) <= Math.max(16, want.r+2);
      if(ok){ practiceCorrect++; highlight(svg, want, true); toast('正解！'); }
      else{ highlight(svg, want, false); toast('ちがうよ。もう一度！'); }
      $('#practiceCorrect').textContent = practiceCorrect;
      $('#practiceTotal').textContent = practiceTotal;
    });
  });
  nextPracticePrompt();
}

function highlight(svg, part, good){
  // draw ring
  const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
  ring.setAttribute('cx', part.x); ring.setAttribute('cy', part.y); ring.setAttribute('r', part.r+8);
  ring.setAttribute('fill','none');
  ring.setAttribute('stroke', good ? '#16a34a' : '#dc2626');
  ring.setAttribute('stroke-width','3');
  ring.setAttribute('opacity','0.9');
  ring.classList.add('hotspot');
  svg.appendChild(ring);
  setTimeout(()=>ring.remove(), 800);
  setTimeout(()=>nextPracticePrompt(), 500);
}

function nextPracticePrompt(){
  practiceIndex = Math.floor(Math.random()*PARTS.length);
  $('#practicePrompt').textContent = showEN ? `${PARTS[practiceIndex].jp} / ${PARTS[practiceIndex].en}` : PARTS[practiceIndex].jp;
}
$('#nextPractice').addEventListener('click', nextPracticePrompt);
$('#resetPractice').addEventListener('click', ()=>{
  practiceCorrect=practiceTotal=0;
  $('#practiceCorrect').textContent = '0';
  $('#practiceTotal').textContent = '0';
  toast('練習の記録をリセットしました');
});

// ====== Quiz ======
function genQuiz(){
  const area = $('#quizArea'); area.innerHTML='';
  // 6 MC + 4 pointing
  const mc = shuffle(MC_BANK).slice(0,6);
  const pointing = shuffle(PARTS).slice(0,4);
  let qn = 1;
  // MC
  mc.forEach((q, idx)=>{
    const div = document.createElement('div'); div.className='q';
    div.innerHTML = `<h4>Q${qn++}. ${q.t}</h4>`;
    q.choices.forEach((c, i)=>{
      const id = `mc_${idx}_${i}`;
      const lab = document.createElement('label'); lab.className='opt';
      lab.innerHTML = `<input type="radio" name="mc_${idx}" value="${i}"> ${c}`;
      div.appendChild(lab);
    });
    area.appendChild(div);
  });
  // Pointing questions
  const svgBase = $('#microscopeSVG').innerHTML;
  pointing.forEach((p, idx)=>{
    const div = document.createElement('div'); div.className='q';
    div.innerHTML = `<h4>Q${qn++}. 次の部位を図から選びなさい：<strong>${p.jp}${showEN?' / '+p.en:''}</strong></h4>`;
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 700 700'); svg.setAttribute('class','diagram');
    svg.innerHTML = svgBase;
    // remove labels
    $$('.hotspot text', svg).forEach(n=>n.remove());
    // listen
    $$('.hotspot', svg).forEach((g)=>{
      g.addEventListener('click', ()=>{
        // store selection
      svg.querySelectorAll('.chosen').forEach(n=>n.classList.remove('chosen'));
        g.classList.add('chosen');
        g.querySelector('circle').setAttribute('stroke','#d97706');
        toast('選択しました');
      }, {once:false});
    });
    div.appendChild(svg);
    // store answer target id
    div.dataset.target = p.id;
    area.appendChild(div);
  });
}
$('#genQuiz').addEventListener('click', genQuiz);
window.addEventListener('load', genQuiz);

$('#submitQuiz').addEventListener('click', ()=>{
  const name = $('#studentName').value.trim() || '(未入力)';
  let score = 0, total = 10;
  let detail=[];
  // MC scoring
  const area = $('#quizArea');
  const mcQs = MC_BANK; // reference for explanations
  let mcIndex=0;
  // score MC in the order generated (first 6 q elements that contain radios)
  const qDivs = $$('.q', area);
  for(const div of qDivs){
    const radios = $$('input[type="radio"]', div);
    if(radios.length){
      const chosen = radios.find(r=>r.checked);
      const bankQ = mcIndex < MC_BANK.length ? mcIndex : 0;
      const correct = MC_BANK[bankQ]?.a ?? 0; // safe
      // But we must identify which MC question this div corresponds to from its text — better: embed data-correct when generating
    }
  }
  // To ensure correct mapping, regenerate scoring by reading data-correct attributes we set during generation
  // Re-generate quiz to include data; modify genQuiz to set data-correct index
});

// Re-define genQuiz with data-correct
function genQuiz2(){
  const area = $('#quizArea'); area.innerHTML='';
  const mc = shuffle(MC_BANK).slice(0,6);
  const pointing = shuffle(PARTS).slice(0,4);
  let qn = 1;
  // MC
  mc.forEach((q, idx)=>{
    const div = document.createElement('div'); div.className='q';
    div.dataset.type='mc'; div.dataset.correct = String(q.a);
    div.innerHTML = `<h4>Q${qn++}. ${q.t}</h4>`;
    q.choices.forEach((c, i)=>{
      const lab = document.createElement('label'); lab.className='opt';
      lab.innerHTML = `<input type="radio" name="mc_${idx}" value="${i}"> ${c}`;
      div.appendChild(lab);
    });
    // store explanation
    div.dataset.exp = q.exp;
    area.appendChild(div);
  });
  // Pointing
  const svgBase = $('#microscopeSVG').innerHTML;
  pointing.forEach((p)=>{
    const div = document.createElement('div'); div.className='q';
    div.dataset.type='point'; div.dataset.target = p.id;
    div.innerHTML = `<h4>Q${qn++}. 次の部位を図から選びなさい：<strong>${p.jp}${showEN?' / '+p.en:''}</strong></h4>`;
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 700 700'); svg.setAttribute('class','diagram');
    svg.innerHTML = svgBase;
    $$('.hotspot text', svg).forEach(n=>n.remove());
    $$('.hotspot', svg).forEach((g)=>{
      g.addEventListener('click', ()=>{
        svg.querySelectorAll('.chosen circle').forEach(c=>c.setAttribute('stroke','#2563eb'));
        svg.querySelectorAll('.chosen').forEach(n=>n.classList.remove('chosen'));
        g.classList.add('chosen');
        g.querySelector('circle').setAttribute('stroke','#d97706');
      });
    });
    area.appendChild(div); div.appendChild(svg);
  });
}
window.addEventListener('load', ()=>{
  genQuiz2();
});

$('#genQuiz').addEventListener('click', genQuiz2);

$('#submitQuiz').addEventListener('click', ()=>{
  const name = $('#studentName').value.trim() || '(未入力)';
  const qs = $$('.q', $('#quizArea'));
  let score=0, total=qs.length, details=[];
  qs.forEach((div, idx)=>{
    const type = div.dataset.type;
    if(type==='mc'){
      const correct = Number(div.dataset.correct);
      const chosen = $$('input[type="radio"]', div).find(r=>r.checked);
      const ok = chosen && Number(chosen.value)===correct;
      if(ok) score++;
      const exp = div.dataset.exp || '';
      details.push(`Q${idx+1}[MC]: ${ok?'○':'×'} ${exp}`);
    }else if(type==='point'){
      const target = div.dataset.target;
      const svg = $('svg', div);
      const chosenG = svg?.querySelector('.chosen');
      let ok=false;
      if(chosenG){
        // identify which part was clicked by proximity to PARTS
        const c = chosenG.querySelector('circle');
        const cx = +c.getAttribute('cx'), cy = +c.getAttribute('cy');
        const want = PARTS.find(p=>p.id===target);
        if(want){ ok = Math.hypot(cx-want.x, cy-want.y) <= Math.max(16, want.r+2); }
      }
      if(ok) score++;
      details.push(`Q${idx+1}[指さし]: ${ok?'○':'×'} 目標=${target}`);
    }
  });
  const percent = Math.round((score/total)*100);
  $('#quizScore').textContent = String(percent);
  $('#quizFeedback').textContent = percent===100 ? '満点！よくできました。' : (percent>=80 ? '合格！あと少しで満点。' : '復習してからもう一度挑戦しよう。');
  $('#quizResult').style.display='block';

  saveResult({time: nowJP(), name, type:'テスト', score:percent, detail: details.join('\\n')});
  toast('結果を保存しました（このブラウザ内）');
});

// ====== Steps & order game ======
function renderSteps(){
  const ol = $('#stepsList'); ol.innerHTML='';
  STEPS.forEach(s=>{
    const li = document.createElement('li'); li.innerHTML = s; ol.appendChild(li);
  });
  buildOrderGame();
}
function buildOrderGame(){
  const box = $('#orderGame'); box.innerHTML='';
  const arr = shuffle(STEPS.map((s,i)=>({text:s, idx:i}))).slice(0,7); // 7 steps subset
  arr.forEach((o,i)=>{
    const row = document.createElement('div');
    row.className='row'; row.style.cssText='justify-content:space-between; border:1px solid #e2e8f0; border-radius:10px; padding:8px; margin:6px 0; background:#fff';
    row.dataset.idx = String(o.idx);
    row.innerHTML = `<span>${o.text}</span>
      <span>
        <button class="btn" data-act="up" aria-label="上へ">▲</button>
        <button class="btn" data-act="down" aria-label="下へ">▼</button>
      </span>`;
    // event
    row.addEventListener('click', (ev)=>{
      const act = ev.target?.dataset?.act;
      if(!act) return;
      const parent = row.parentElement;
      const rows = Array.from(parent.children);
      const pos = rows.indexOf(row);
      if(act==='up' && pos>0){ parent.insertBefore(row, rows[pos-1]); }
      if(act==='down' && pos<rows.length-1){ parent.insertBefore(rows[pos+1], row); }
    });
    box.appendChild(row);
  });
}
$('#shuffleSteps').addEventListener('click', buildOrderGame);
$('#checkOrder').addEventListener('click', ()=>{
  const rows = Array.from($('#orderGame').children);
  const order = rows.map(r=>Number(r.dataset.idx));
  // score by how close to ascending
  let correct = 0;
  for(let i=1;i<order.length;i++){ if(order[i]>order[i-1]) correct++; }
  const percent = Math.round(100*correct/(order.length-1));
  $('#orderScore').textContent = String(percent);
  const name = $('#studentName').value.trim() || '(未入力)';
  saveResult({time: nowJP(), name, type:'手順並べ替え', score:percent, detail:`順序=${order.join('>')}`});
  toast('採点しました（保存済み）');
});

// ====== Helpers ======
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

// ====== Init ======
renderHotspots();
renderGlossary();
renderPractice();
renderSteps();
</script>
</body>
</html>
