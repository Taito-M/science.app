<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>光学顕微鏡（生物顕微鏡） 学習アプリ</title>
<style>
  :root{
    --bg:#f7fafc;
    --card:#ffffff;
    --ink:#1f2937;
    --muted:#4b5563;
    --accent:#2563eb;
    --ok:#16a34a;
    --bad:#dc2626;
    --gold:#d97706;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","游ゴシック体","Yu Gothic", "Noto Sans JP", "Meiryo", sans-serif;
    color:var(--ink);
    background:var(--bg);
    line-height:1.6;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg,#ffffffcc,#ffffffcc), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><rect width="8" height="8" fill="white"/><path d="M0 8 L8 0" stroke="%23e2e8f0" /></svg>');
    backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid #e2e8f0;
  }
  .bar{max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between}
  h1{font-size:clamp(18px,3.2vw,24px); margin:0; font-weight:700}
  .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .meta input[type="text"]{padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; min-width:180px; background:#fff}
  .btn{border:1px solid #cbd5e1; background:#fff; color:var(--ink); border-radius:10px; padding:8px 12px; cursor:pointer; transition:transform .05s ease, box-shadow .2s ease}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent); color:#fff; border-color:transparent}
  .btn.good{background:var(--ok); color:#fff; border-color:transparent}
  .btn.warn{background:var(--gold); color:#fff; border-color:transparent}
  .btn.ghost{background:transparent}
  .tabs{max-width:1100px; margin:14px auto; padding:0 16px}
  .tabbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
  .tabbar button{background:#fff; border:1px solid #cbd5e1; color:var(--muted); padding:10px 12px; border-radius:999px; cursor:pointer}
  .tabbar button.active{background:var(--accent); color:#fff; border-color:transparent}
  .card{background:var(--card); border:1px solid #e2e8f0; border-radius:14px; padding:16px}
  .grid{display:grid; gap:16px}
  @media(min-width:950px){ .grid.two{grid-template-columns:1.2fr 1fr} }
  .diagram{width:100%; height:auto; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:12px; padding:8px}
  .legend{display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:14px}
  .pill{border-radius:999px; padding:4px 10px; background:#eef2ff; border:1px solid #c7d2fe}
  .hotspot{cursor:pointer; transition:transform .15s ease}
  .hotspot:hover{transform:scale(1.05)}
  .hint{font-size:14px; color:var(--muted)}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .q{padding:12px; border:1px solid #e2e8f0; border-radius:12px; margin-bottom:8px}
  .q h4{margin:0 0 8px 0}
  .opt{display:block; margin:.35rem 0; padding:.35rem .5rem; border-radius:8px; border:1px solid #e2e8f0; background:#fff; cursor:pointer}
  .opt input{margin-right:.5rem}
  .score{font-weight:700}
  .tag{display:inline-block; border:1px solid #cbd5e1; padding:3px 8px; border-radius:999px; font-size:12px; color:var(--muted)}
  .footer{max-width:1100px; margin:20px auto; padding:0 16px 30px; color:var(--muted); font-size:13px}
  details summary{cursor:pointer}
  .toast{position:fixed; bottom:16px; right:16px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.25); display:none}
</style>
</head>
<body>
<header>
  <div class="bar">
    <h1>光学顕微鏡（生物顕微鏡） 学習アプリ</h1>
    <div class="meta">
      <input id="studentName" type="text" placeholder="名前を入力">
      <button class="btn primary" id="lockIn">開始</button>
      <button class="btn ghost" id="toggleLang" aria-pressed="false">英語も表示</button>
      <button class="btn ghost" id="teacherModeBtn" aria-pressed="false">先生モード</button>
    </div>
  </div>
</header>

<main class="tabs">
  <nav class="tabbar" role="tablist" aria-label="学習モード">
    <button role="tab" aria-selected="true" id="tab-learn" class="active" data-tab="learn">① 学ぶ</button>
    <button role="tab" aria-selected="false" id="tab-practice" data-tab="practice" disabled>② 練習（指さし）</button>
    <button role="tab" aria-selected="false" id="tab-quiz" data-tab="quiz" disabled>③ 小テスト</button>
    <button role="tab" aria-selected="false" id="tab-steps" data-tab="steps" disabled>④ 使い方手順</button>
    <button role="tab" aria-selected="false" id="tab-admin" data-tab="admin" hidden>教師</button>
  </nav>

  <!-- Learn -->
  <section id="panel-learn" class="card grid two" role="tabpanel" aria-labelledby="tab-learn">
    <div>
      <div class="legend">
        <span class="pill">図をタップで名称と説明</span>
        <span class="pill">ピン＝部位</span>
        <span class="pill">下部LEDで透過観察</span>
      </div>
      <svg id="microscopeSVG" class="diagram" viewBox="0 0 700 700" aria-label="光学顕微鏡 図">
        <defs><filter id="shadow"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.2"/></filter></defs>
        <!-- base -->
        <rect x="190" y="600" width="320" height="35" rx="10" fill="#e5e7eb" stroke="#cbd5e1"></rect>
        <rect x="210" y="560" width="280" height="60" rx="14" fill="#f1f5f9" stroke="#cbd5e1"></rect>
        <!-- arm -->
        <path d="M280,560 C280,430 310,300 360,250 C380,230 420,220 440,230 L440,560 Z" fill="#e5e7eb" stroke="#cbd5e1"></path>
        <!-- body tube -->
        <rect x="335" y="180" width="30" height="120" rx="12" fill="#d1d5db" stroke="#9ca3af"></rect>
        <!-- head/eyepiece -->
        <rect x="330" y="150" width="40" height="25" rx="8" fill="#111827"></rect>
        <!-- revolving nosepiece -->
        <circle cx="350" cy="305" r="24" fill="#94a3b8" stroke="#64748b"></circle>
        <!-- objectives (stylized) -->
        <rect x="330" y="325" width="14" height="30" rx="4" fill="#ef4444" stroke="#9ca3af"></rect>
        <rect x="348" y="325" width="14" height="34" rx="4" fill="#f59e0b" stroke="#9ca3af"></rect>
        <rect x="366" y="325" width="14" height="40" rx="4" fill="#3b82f6" stroke="#9ca3af"></rect>
        <!-- stage -->
        <rect x="220" y="360" width="260" height="18" rx="8" fill="#111827" stroke="#374151" filter="url(#shadow)"></rect>
        <!-- stage opening -->
        <circle cx="350" cy="371" r="8" fill="#374151"></circle>
        <!-- stage clips -->
        <rect x="245" y="350" width="40" height="10" rx="2" fill="#9ca3af"></rect>
        <rect x="415" y="350" width="40" height="10" rx="2" fill="#9ca3af"></rect>
        <!-- condenser -->
        <circle cx="350" cy="400" r="16" fill="#9ca3af" stroke="#6b7280"></circle>
        <!-- diaphragm lever -->
        <rect x="372" y="394" width="28" height="8" rx="4" fill="#6b7280"></rect>
        <!-- illuminator -->
        <circle cx="350" cy="525" r="12" fill="#bfdbfe" stroke="#60a5fa"></circle>
        <!-- coarse & fine knobs -->
        <circle cx="500" cy="330" r="30" fill="#94a3b8" stroke="#64748b"></circle>
        <circle cx="500" cy="370" r="18" fill="#cbd5e1" stroke="#94a3b8"></circle>
        <!-- stage control knobs -->
        <circle cx="500" cy="430" r="16" fill="#94a3b8" stroke="#64748b"></circle>
        <circle cx="520" cy="430" r="10" fill="#cbd5e1" stroke="#94a3b8"></circle>
        <!-- power & brightness -->
        <rect x="225" y="575" width="20" height="14" rx="3" fill="#10b981"></rect>
        <circle cx="470" cy="575" r="12" fill="#fde68a" stroke="#f59e0b"></circle>
        <!-- labels/hotspots via JS -->
      </svg>
      <p class="hint">右上「英語も表示」で和英の同時表示を切替できます。</p>
      <div id="infoBox" class="card" style="margin-top:10px">
        <strong>部位説明</strong>
        <div id="partInfo">図のピンをタップすると、ここに説明が表示されます。</div>
      </div>
    </div>
    <aside>
      <div class="card">
        <h3>観察のコツ</h3>
        <ul>
          <li><strong>低倍率（4×）</strong>から始める。ステージは下げておく。</li>
          <li>横から見ながら<strong>粗動</strong>でレンズとスライドの距離を近づけ、のぞいて<strong>微動</strong>で合わせる。</li>
          <li><strong>絞り（虹彩絞り）</strong>でコントラスト、<strong>コンデンサー</strong>で光の集光を調整。</li>
          <li>倍率を上げたら、<strong>微動</strong>のみでピント合わせ。粗動は使わない。</li>
          <li>レンズはレンズ紙で軽く拭く。<strong>ティッシュ不可</strong>。</li>
        </ul>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>言葉（和英）</h3>
        <ul id="glossary"></ul>
      </div>
    </aside>
  </section>

  <!-- Practice -->
  <section id="panel-practice" class="card grid two" role="tabpanel" aria-labelledby="tab-practice" hidden>
    <div>
      <div class="row">
        <span class="pill">問題：<span id="practicePrompt">—</span></span>
        <button class="btn" id="nextPractice">次の問題</button>
      </div>
      <svg id="practiceSVG" class="diagram" viewBox="0 0 700 700" aria-label="練習 図"></svg>
      <p class="hint">指示された部位を図から<strong>タップ</strong>してください。</p>
      <div class="row">
        <span class="score">正解：<span id="practiceCorrect">0</span> / <span id="practiceTotal">0</span></span>
        <button class="btn good" id="resetPractice">リセット</button>
      </div>
    </div>
    <aside class="card">
      <h3>学習目標</h3>
      <p>全パーツを3回連続で正解できたら合格！</p>
      <ul>
        <li>場所を<strong>見て覚える</strong></li>
        <li>名前と<strong>機能</strong>を結びつける</li>
      </ul>
    </aside>
  </section>

  <!-- Quiz -->
  <section id="panel-quiz" class="card" role="tabpanel" aria-labelledby="tab-quiz" hidden>
    <div class="row" style="justify-content:space-between; align-items:center">
      <div>
        <span class="tag">10問</span>
        <span class="tag">選択式＋指さし混合</span>
      </div>
      <div class="row">
        <button class="btn" id="genQuiz">新しいテスト</button>
        <button class="btn primary" id="submitQuiz">採点する</button>
      </div>
    </div>
    <div id="quizArea"></div>
    <div id="quizResult" class="card" style="margin-top:10px; display:none">
      <h3>結果</h3>
      <p class="score">スコア：<span id="quizScore">0</span> 点（100点満点）</p>
      <p>フィードバック：<span id="quizFeedback">—</span></p>
    </div>
  </section>

  <!-- Steps -->
  <section id="panel-steps" class="card grid two" role="tabpanel" aria-labelledby="tab-steps" hidden>
    <div>
      <h3>正しい使い方（手順）</h3>
      <ol id="stepsList"></ol>
      <details style="margin-top:8px">
        <summary>ポイント（安全・片付け）</summary>
        <ul>
          <li>倍率を下げ、ステージを下げ、光量ゼロ→電源OFF→ダストカバー。</li>
          <li>レンズはレンズ紙のみで清拭。<strong>アルコールは不可の機種あり</strong>。</li>
          <li>持ち運びは<strong>アーム＋台座</strong>を両手で。</li>
        </ul>
      </details>
    </div>
    <aside>
      <h3>手順並べ替え練習</h3>
      <p class="hint">各行をタップして選択し、上下の矢印で順番を整えよう。</p>
      <div id="orderGame" class="card"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="shuffleSteps">シャッフル</button>
        <button class="btn primary" id="checkOrder">採点</button>
      </div>
      <p class="score">正解率：<span id="orderScore">0</span>%</p>
    </aside>
  </section>

  <!-- Admin -->
  <section id="panel-admin" class="card" role="tabpanel" aria-labelledby="tab-admin" hidden>
    <h3>先生モード</h3>
    <div class="row">
      <input id="pin" type="text" placeholder="PIN（初期値: 0000）" style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px">
      <button class="btn" id="enterPin">開く</button>
      <button class="btn warn" id="resetAll">データ初期化</button>
      <button class="btn" id="exportCSV">CSVダウンロード</button>
    </div>
    <p class="hint">このPCのブラウザに保存された学習・テスト結果をCSVで出力します（UTF-8 BOM付 / Excelで文字化けしません）。</p>
    <div id="adminTable"></div>
  </section>

</main>

<div class="footer">
  <details>
    <summary>このアプリについて（オフライン対応）</summary>
    <p>このファイル1つで動作します。インターネット不要。<br>iPad / iPhone でもSafariで動作します。</p>
  </details>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
// ====== Data ======
const PARTS = [
  {id:'eyepiece', jp:'接眼レンズ', en:'Eyepiece', x:350, y:160, r:14, info:'目を当てるレンズ。像を拡大して目に届けます。'},
  {id:'tube', jp:'鏡筒', en:'Body Tube', x:350, y:220, r:14, info:'接眼レンズと対物レンズをつなぐ筒。光の通り道。'},
  {id:'nosepiece', jp:'レボルバー（回転鏡筒）', en:'Revolving Nosepiece', x:350, y:305, r:16, info:'対物レンズを回して切り替える部分。カチッと位置決めまで回す。'},
  {id:'obj4', jp:'対物レンズ（低倍率 4×）', en:'Objective 4× (Low)', x:337, y:340, r:12, info:'視野が広くピント合わせが容易。観察はここからスタート。'},
  {id:'obj10', jp:'対物レンズ（中倍率 10×）', en:'Objective 10× (Medium)', x:355, y:343, r:12, info:'細部を見るときに使用。微動でピント合わせ。'},
  {id:'obj40', jp:'対物レンズ（高倍率 40×）', en:'Objective 40× (High)', x:373, y:347, r:12, info:'高倍率。粗動は使用禁止。微動のみでピントを合わせる。'},
  {id:'stage', jp:'ステージ', en:'Stage', x:350, y:365, r:16, info:'プレパラートを置く台。中央に穴（開口）がある。'},
  {id:'clips', jp:'プレパラート押さえ', en:'Stage Clips', x:250, y:355, r:12, info:'プレパラートを軽く固定。押し付けすぎない。'},
  {id:'condenser', jp:'コンデンサー', en:'Condenser', x:350, y:400, r:14, info:'光を集光して試料に当てるレンズ。高さ調整つまみがある機種も。'},
  {id:'diaphragm', jp:'虹彩絞り（しぼり）', en:'Iris Diaphragm', x:386, y:400, r:12, info:'光量とコントラストを調整。明るすぎるとコントラスト低下。'},
  {id:'coarse', jp:'粗動ねじ', en:'Coarse Focus', x:500, y:330, r:20, info:'ステージを大きく上下してピントを大まかに合わせる。<strong>高倍率では使わない</strong>。'},
  {id:'fine', jp:'微動ねじ', en:'Fine Focus', x:500, y:370, r:16, info:'ピントを微調整。高倍率で使用。'},
  {id:'stageKnob', jp:'ステージ送りねじ（XY）', en:'Mechanical Stage Knobs', x:510, y:430, r:16, info:'プレパラートを左右・前後に微動させる。中心合わせに便利。'},
  {id:'lamp', jp:'照明（LED）', en:'Illuminator', x:350, y:525, r:14, info:'下から光を当てる。明るさは必要最小限に。'},
  {id:'power', jp:'電源スイッチ', en:'Power Switch', x:235, y:580, r:12, info:'ON/OFF。コード接続はOFFのまま行う。'},
  {id:'dim', jp:'光量調整つまみ', en:'Brightness Control', x:470, y:575, r:12, info:'明るさを調整。白飛びに注意。'},
  {id:'arm', jp:'アーム（柄）', en:'Arm', x:420, y:300, r:16, info:'本体を支える部分。持ち運ぶときは台座と一緒に両手で持つ。'},
  {id:'base', jp:'鏡基（台座）', en:'Base', x:350, y:600, r:18, info:'本体の土台。安定した机で使用する。'}
];

const STEPS = [
  '安定した机に本体を置き、周囲を片付ける。',
  '電源コードを確認し、<strong>スイッチOFF</strong>のまま接続。',
  'ステージを<strong>下げ</strong>、対物レンズを<strong>4×</strong>に合わせる。',
  'プレパラートをステージにのせ、クリップで軽く固定。',
  '横から見ながら<strong>粗動</strong>でレンズとスライドを近づける。',
  '接眼からのぞき、<strong>微動</strong>でピントを合わせる。',
  '絞り（虹彩絞り）とコンデンサーで明るさ・コントラストを調整。',
  '観察対象をステージ送りねじ（XY）で中心に合わせる。',
  '倍率を上げるときは対物レンズを切り替え、<strong>微動のみ</strong>で再調整。',
  '観察後：倍率を下げ、ステージを下げ、光量ゼロ→電源OFF→カバー。',
  '移動時：アームと台座を<strong>両手</strong>で持つ。'
];

const MC_BANK = [
  {t:'最初に使う対物レンズとして正しいのは？', choices:['40×','10×','4×'], a:2, exp:'視野が広くピント合わせが簡単な4×から始めます。'},
  {t:'高倍率（40×）でピントを合わせるときに使うのは？', choices:['粗動ねじ','微動ねじ','どちらでもよい'], a:1, exp:'高倍率では微動のみ。粗動はレンズやスライド破損の危険あり。'},
  {t:'横から見ながら操作するのはどれ？', choices:['ステージを上げる粗動操作','絞りの調整','ステージ送り（XY）'], a:0, exp:'レンズとスライドがぶつからないよう、接近時は横から確認。'},
  {t:'絞り（虹彩絞り）の役割は？', choices:['倍率を変える','コントラストと光量の調整','ピントの微調整'], a:1, exp:'絞りで光の量と像のコントラストを最適化します。'},
  {t:'視野中心に対象を合わせるとき使うのは？', choices:['ステージ送りねじ（XY）','粗動ねじ','光量つまみ'], a:0, exp:'XY送りでプレパラート位置を微調整します。'},
  {t:'プレパラートの固定で正しいのは？', choices:['強く押さえつける','軽く固定する','固定しない'], a:1, exp:'軽く固定し、ステージ送りで動くようにします。'},
  {t:'清掃で正しいのは？', choices:['ティッシュで強くこする','レンズ紙でやさしく拭く','消しゴムで汚れを取る'], a:1, exp:'レンズ紙を使用。ティッシュは傷や繊維が残る。'},
  {t:'観察後の片付けで誤っているのは？', choices:['倍率を下げる','ステージを上げたままにする','電源を切る'], a:1, exp:'次の人のためにステージは下げ、倍率も低に戻します。'},
  {t:'照明の明るさ調整で注意することは？', choices:['常に最大にする','必要最小限にする','暗くして粗動で補う'], a:1, exp:'白飛びや熱の影響を避けるため、必要最小限に。'},
  {t:'持ち運びの正しい方法は？', choices:['アームだけを片手で持つ','ステージを掴む','アームと台座を両手で持つ'], a:2, exp:'必ず両手で安定して運びます。'}
];

// ====== Utilities ======
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
function toast(msg){ const t = $('#toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
function nowJP(){ try{ return new Date().toLocaleString('ja-JP', {hour12:false}); }catch(e){ return new Date().toISOString(); } }

// Local storage helpers
const KEY_RESULTS='bio_scope_results_v1';
function loadResults(){ try{ return JSON.parse(localStorage.getItem(KEY_RESULTS) || '[]'); }catch(e){ return []; } }
function saveResult(rec){ const arr = loadResults(); arr.push(rec); localStorage.setItem(KEY_RESULTS, JSON.stringify(arr)); }

// ====== Tabs / gating ======
const tabs = ['learn','practice','quiz','steps','admin'];
tabs.forEach(id=>{ $('#tab-'+id)?.addEventListener('click', ()=>showTab(id)); });
function showTab(id){
  tabs.forEach(t=>{
    $('#panel-'+t)?.setAttribute('hidden','');
    $('#tab-'+t)?.classList.remove('active');
    $('#tab-'+t)?.setAttribute('aria-selected','false');
  });
  $('#panel-'+id)?.removeAttribute('hidden');
  $('#tab-'+id)?.classList.add('active');
  $('#tab-'+id)?.setAttribute('aria-selected','true');
}
$('#lockIn').addEventListener('click', ()=>{
  const name = $('#studentName').value.trim();
  if(!name){ toast('名前を入力してください'); return; }
  ['practice','quiz','steps'].forEach(t=>{ $('#tab-'+t).disabled=false; });
  toast('準備OK。学習を始めましょう！');
});

// Language toggle
let showEN=false;
$('#toggleLang').addEventListener('click', (e)=>{
  showEN = !showEN;
  e.currentTarget.setAttribute('aria-pressed', String(showEN));
  e.currentTarget.textContent = showEN ? '日本語のみ' : '英語も表示';
  renderGlossary(); renderHotspots(); renderPractice();
});

// Teacher mode
let adminOpen=false;
$('#teacherModeBtn').addEventListener('click', ()=>{ showTab('admin'); });
$('#enterPin').addEventListener('click', ()=>{
  const pin = $('#pin').value.trim();
  if(pin==='0000' || pin==='2468' || pin==='1357'){
    adminOpen=true; $('#tab-admin').hidden=false; renderAdmin(); toast('先生モードを開きました');
  }else{ adminOpen=false; $('#tab-admin').hidden=true; toast('PINが違います'); }
});

$('#resetAll').addEventListener('click', ()=>{
  if(confirm('本当にこのブラウザ内の学習/テスト結果を消去しますか？')){
    localStorage.removeItem(KEY_RESULTS); renderAdmin(); toast('データを初期化しました');
  }
});

$('#exportCSV').addEventListener('click', ()=>{
  const rows = loadResults();
  const headers = ['日時','氏名','種別','詳細','得点'];
  const bom = '\\ufeff'; // UTF-8 BOM for Excel
  const lines = [headers.join(',')];
  for(const r of rows){
    const line = [r.time, r.name, r.type, (r.detail||'').replace(/\\n/g,' '), r.score??''].map(s=>`"${String(s).replace(/"/g,'""')}"`).join(',');
    lines.push(line);
  }
  const blob = new Blob([bom + lines.join('\\r\\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='compound_microscope_results.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('CSVをダウンロードしました');
});
function renderAdmin(){
  const rows = loadResults().slice().reverse();
  const wrap = $('#adminTable');
  if(!rows.length){ wrap.innerHTML = '<p class="hint">保存データはありません。</p>'; return; }
  const html = [`<div style="overflow:auto"><table style="min-width:700px; border-collapse:collapse">`,
    `<thead><tr style="background:#f1f5f9"><th style="border:1px solid #e2e8f0; padding:6px 8px">日時</th><th style="border:1px solid #e2e8f0; padding:6px 8px">氏名</th><th style="border:1px solid #e2e8f0; padding:6px 8px">種別</th><th style="border:1px solid #e2e8f0; padding:6px 8px">得点</th><th style="border:1px solid #e2e8f0; padding:6px 8px">詳細</th></tr></thead><tbody>`];
  for(const r of rows){
    html.push(`<tr>
      <td style="border:1px solid #e2e8f0; padding:6px 8px; white-space:nowrap">${r.time}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${r.name||''}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${r.type}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${r.score??''}</td>
      <td style="border:1px solid #e2e8f0; padding:6px 8px">${(r.detail||'').replace(/\\n/g,'<br>')}</td>
    </tr>`);
  }
  html.push('</tbody></table></div>');
  wrap.innerHTML = html.join('');
}

// ====== Learn: hotspots ======
function renderHotspots(){
  const svg = $('#microscopeSVG');
  $$('.hotspot', svg).forEach(n=>n.remove());
  for(const p of PARTS){
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.classList.add('hotspot');
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx', p.x); c.setAttribute('cy', p.y); c.setAttribute('r', p.r);
    c.setAttribute('fill', 'rgba(37,99,235,.15)'); c.setAttribute('stroke', '#2563eb'); c.setAttribute('stroke-width','2');
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', p.x); t.setAttribute('y', p.y - (p.r+6));
    t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','12'); t.setAttribute('fill','#111827');
    t.textContent = showEN ? `${p.jp} / ${p.en}` : p.jp;
    t.setAttribute('pointer-events','none');
    g.appendChild(c); g.appendChild(t);
    g.addEventListener('click', ()=>showPartInfo(p));
    svg.appendChild(g);
  }
}
function showPartInfo(p){ $('#partInfo').innerHTML = `<div><strong>${p.jp}${showEN? ' / '+p.en:''}</strong><br>${p.info}</div>`; }
// glossary
function renderGlossary(){
  const ul = $('#glossary'); ul.innerHTML='';
  PARTS.forEach(p=>{ const li=document.createElement('li'); li.innerHTML = showEN ? `<strong>${p.jp}</strong> — ${p.en}` : `<strong>${p.jp}</strong>`; ul.appendChild(li); });
}

// ====== Practice ======
let practiceIndex=0, practiceCorrect=0, practiceTotal=0;
function renderPractice(){
  const svg = $('#practiceSVG');
  svg.innerHTML = $('#microscopeSVG').innerHTML;
  $$('.hotspot text', svg).forEach(n=>n.remove());
  $$('.hotspot', svg).forEach((g,i)=>{
    const part = PARTS[i];
    g.addEventListener('click', ()=>{
      practiceTotal++;
      const want = PARTS[practiceIndex];
      const cx = +$('circle', g).getAttribute('cx'); const cy = +$('circle', g).getAttribute('cy');
      const ok = Math.hypot(cx-want.x, cy-want.y) <= Math.max(16, want.r+2);
      if(ok){ practiceCorrect++; highlight(svg, want, true); toast('正解！'); }
      else{ highlight(svg, want, false); toast('ちがうよ。もう一度！'); }
      $('#practiceCorrect').textContent = practiceCorrect; $('#practiceTotal').textContent = practiceTotal;
    });
  });
  nextPracticePrompt();
}
function highlight(svg, part, good){
  const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
  ring.setAttribute('cx', part.x); ring.setAttribute('cy', part.y); ring.setAttribute('r', part.r+8);
  ring.setAttribute('fill','none'); ring.setAttribute('stroke', good ? '#16a34a' : '#dc2626'); ring.setAttribute('stroke-width','3'); ring.setAttribute('opacity','0.9');
  svg.appendChild(ring); setTimeout(()=>ring.remove(), 800); setTimeout(()=>nextPracticePrompt(), 500);
}
function nextPracticePrompt(){ practiceIndex = Math.floor(Math.random()*PARTS.length); $('#practicePrompt').textContent = showEN ? `${PARTS[practiceIndex].jp} / ${PARTS[practiceIndex].en}` : PARTS[practiceIndex].jp; }
$('#nextPractice').addEventListener('click', nextPracticePrompt);
$('#resetPractice').addEventListener('click', ()=>{ practiceCorrect=practiceTotal=0; $('#practiceCorrect').textContent='0'; $('#practiceTotal').textContent='0'; toast('練習の記録をリセットしました'); });

// ====== Quiz ======
function genQuiz(){
  const area = $('#quizArea'); area.innerHTML='';
  const mc = shuffle(MC_BANK).slice(0,6);
  const pointing = shuffle(PARTS).slice(0,4);
  let qn = 1;
  // MC
  mc.forEach((q, idx)=>{
    const div = document.createElement('div'); div.className='q';
    div.dataset.type='mc'; div.dataset.correct = String(q.a); div.dataset.exp = q.exp;
    div.innerHTML = `<h4>Q${qn++}. ${q.t}</h4>`;
    q.choices.forEach((c, i)=>{
      const lab = document.createElement('label'); lab.className='opt';
      lab.innerHTML = `<input type="radio" name="mc_${idx}" value="${i}"> ${c}`;
      div.appendChild(lab);
    });
    area.appendChild(div);
  });
  // Pointing
  const svgBase = $('#microscopeSVG').innerHTML;
  pointing.forEach((p)=>{
    const div = document.createElement('div'); div.className='q';
    div.dataset.type='point'; div.dataset.target = p.id;
    div.innerHTML = `<h4>Q${qn++}. 次の部位を図から選びなさい：<strong>${p.jp}${showEN?' / '+p.en:''}</strong></h4>`;
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 700 700'); svg.setAttribute('class','diagram');
    svg.innerHTML = svgBase; $$('.hotspot text', svg).forEach(n=>n.remove());
    $$('.hotspot', svg).forEach((g)=>{
      g.addEventListener('click', ()=>{
        svg.querySelectorAll('.chosen circle').forEach(c=>c.setAttribute('stroke','#2563eb'));
        svg.querySelectorAll('.chosen').forEach(n=>n.classList.remove('chosen'));
        g.classList.add('chosen'); g.querySelector('circle').setAttribute('stroke','#d97706');
      });
    });
    area.appendChild(div); div.appendChild(svg);
  });
}
$('#genQuiz').addEventListener('click', genQuiz);
window.addEventListener('load', genQuiz);

$('#submitQuiz').addEventListener('click', ()=>{
  const name = $('#studentName').value.trim() || '(未入力)';
  const qs = $$('.q', $('#quizArea'));
  let score=0, total=qs.length, details=[];
  qs.forEach((div, idx)=>{
    const type = div.dataset.type;
    if(type==='mc'){
      const correct = Number(div.dataset.correct);
      const chosen = $$('input[type="radio"]', div).find(r=>r.checked);
      const ok = chosen && Number(chosen.value)===correct;
      if(ok) score++;
      const exp = div.dataset.exp || '';
      details.push(`Q${idx+1}[MC]: ${ok?'○':'×'} ${exp}`);
    }else if(type==='point'){
      const target = div.dataset.target;
      const svg = $('svg', div);
      const chosenG = svg?.querySelector('.chosen');
      let ok=false;
      if(chosenG){
        const c = chosenG.querySelector('circle');
        const cx = +c.getAttribute('cx'), cy = +c.getAttribute('cy');
        const want = PARTS.find(p=>p.id===target);
        if(want){ ok = Math.hypot(cx-want.x, cy-want.y) <= Math.max(16, want.r+2); }
      }
      if(ok) score++;
      details.push(`Q${idx+1}[指さし]: ${ok?'○':'×'} 目標=${target}`);
    }
  });
  const percent = Math.round((score/total)*100);
  $('#quizScore').textContent = String(percent);
  $('#quizFeedback').textContent = percent===100 ? '満点！よくできました。' : (percent>=80 ? '合格！あと少しで満点。' : '復習してからもう一度挑戦しよう。');
  $('#quizResult').style.display='block';
  saveResult({time: nowJP(), name, type:'テスト', score:percent, detail: details.join('\\n')});
  toast('結果を保存しました（このブラウザ内）');
});

// ====== Steps & order game ======
function renderSteps(){
  const ol = $('#stepsList'); ol.innerHTML='';
  STEPS.forEach(s=>{ const li=document.createElement('li'); li.innerHTML=s; ol.appendChild(li); });
  buildOrderGame();
}
function buildOrderGame(){
  const box = $('#orderGame'); box.innerHTML='';
  const arr = shuffle(STEPS.map((s,i)=>({text:s, idx:i}))).slice(0,7);
  arr.forEach(o=>{
    const row = document.createElement('div');
    row.className='row'; row.style.cssText='justify-content:space-between; border:1px solid #e2e8f0; border-radius:10px; padding:8px; margin:6px 0; background:#fff';
    row.dataset.idx = String(o.idx);
    row.innerHTML = `<span>${o.text}</span>
      <span><button class="btn" data-act="up" aria-label="上へ">▲</button>
      <button class="btn" data-act="down" aria-label="下へ">▼</button></span>`;
    row.addEventListener('click', (ev)=>{
      const act = ev.target?.dataset?.act; if(!act) return;
      const parent = row.parentElement; const rows = Array.from(parent.children); const pos = rows.indexOf(row);
      if(act==='up' && pos>0){ parent.insertBefore(row, rows[pos-1]); }
      if(act==='down' && pos<rows.length-1){ parent.insertBefore(rows[pos+1], row); }
    });
    box.appendChild(row);
  });
}
$('#shuffleSteps').addEventListener('click', buildOrderGame);
$('#checkOrder').addEventListener('click', ()=>{
  const rows = Array.from($('#orderGame').children);
  const order = rows.map(r=>Number(r.dataset.idx));
  let correct = 0;
  for(let i=1;i<order.length;i++){ if(order[i]>order[i-1]) correct++; }
  const percent = Math.round(100*correct/(order.length-1));
  $('#orderScore').textContent = String(percent);
  const name = $('#studentName').value.trim() || '(未入力)';
  saveResult({time: nowJP(), name, type:'手順並べ替え', score:percent, detail:`順序=${order.join('>')}`});
  toast('採点しました（保存済み）');
});

// ====== Helpers ======
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
// ====== Init ======
renderHotspots(); renderGlossary(); renderPractice(); renderSteps();
</script>
</body>
</html>
