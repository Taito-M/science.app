<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>元素クイズ Z=1–36 内蔵（初級/中級/上級）</title>
<style>
  :root{
    --bg:#f7fafc; --panel:#ffffff; --ink:#1a202c; --muted:#4a5568; --accent:#2563eb; --ok:#16a34a; --ng:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Helvetica Neue", Arial, "メイリオ", Meiryo, sans-serif;color:var(--ink);background:var(--bg);}
  header{padding:18px 16px;background:linear-gradient(180deg,#e6f0ff,transparent);}
  h1{margin:0;font-size:clamp(18px,3.6vw,28px)}
  .wrap{max-width:980px;margin:0 auto;padding:0 16px 28px}
  .panel{background:var(--panel);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px;margin-top:16px}
  .levels{display:flex;gap:8px;flex-wrap:wrap}
  .lv-btn{cursor:pointer;border:1px solid #cbd5e1;background:#fff;border-radius:999px;padding:8px 14px;font-weight:600;color:#334155}
  .lv-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){ .grid{grid-template-columns:1.2fr .8fr} }
  .qbox{padding:14px;border:1px solid #e2e8f0;border-radius:12px;min-height:84px;font-size:18px;line-height:1.6}
  .answer-row{display:flex;gap:8px;flex-wrap:wrap}
  input[type="text"]{flex:1;min-width:200px;padding:12px 12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px}
  button{cursor:pointer;border:none;border-radius:12px;padding:12px 14px;font-weight:700}
  .primary{background:var(--accent);color:#fff}
  .ghost{background:#eef2ff;color:#1e293b}
  .warn{background:#fee2e2;color:#991b1b}
  .muted{color:var(--muted);font-size:14px}
  .stats{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .stat{background:#f1f5f9;border-radius:12px;padding:8px 12px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:999px;padding:4px 10px;font-size:12px}
  .result{min-height:28px;font-weight:700}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:linear-gradient(90deg,#60a5fa,#2563eb)}
  details{border:1px dashed #cbd5e1;border-radius:12px;padding:12px}
  .kbd{font:600 12px/1 system-ui;padding:.25em .5em;border:1px solid #cbd5e1;border-bottom-width:2px;border-radius:6px;background:#fff}
  .list{max-height:220px;overflow:auto;border:1px solid #e2e8f0;border-radius:12px;padding:8px}
  .footer{margin-top:16px;font-size:12px;color:#64748b}
</style>
</head>
<body>
<header class="wrap">
  <h1>元素クイズ（Z=1–36：180問内蔵・CSVで拡張可）</h1>
  <div class="muted">短い一問一答。<b>初級・中級・上級</b>に分かれ、<b>ランダム出題＆重複なし</b>。<b>出題数/正解数</b>を常時表示。進捗は端末に保存（localStorage）。</div>
</header>

<main class="wrap panel">
  <section class="levels" id="levels"></section>

  <div class="grid">
    <!-- Left: Play -->
    <section>
      <div class="qbox" id="question">レベルを選んで「出題開始」を押してください。</div>
      <div class="answer-row">
        <input id="answer" type="text" placeholder="解答（例：水素 / H / hydrogen）" autocomplete="off" disabled />
        <button class="primary" id="btnSubmit" disabled>解答する ⏎</button>
        <button class="ghost" id="btnPass" disabled>パス</button>
      </div>
      <div class="result" id="result"></div>

      <div class="stats">
        <div class="stat">出題数：<span id="shown">0</span></div>
        <div class="stat">正解数：<span id="correct">0</span></div>
        <div class="stat">正答率：<span id="rate">0%</span></div>
        <span class="pill" id="leftpill">残り：0</span>
      </div>
      <div class="progress" aria-label="進捗（このレベル内）">
        <div id="progbar" style="width:0%"></div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="btnStart" class="primary">出題開始</button>
        <button id="btnReveal" class="ghost" disabled>答えを表示</button>
        <button id="btnNext" class="ghost" disabled>次の問題</button>
        <button id="btnReset" class="warn">このレベルをリセット</button>
      </div>
      <p class="muted">ショートカット：<span class="kbd">Enter</span>=解答 / <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span>=次へ / <span class="kbd">Esc</span>=パス</p>
    </section>

    <!-- Right: Bank & Import -->
    <aside>
      <details>
        <summary><b>問題を追加（CSV/TSV/貼り付け）</b></summary>
        <p class="muted">形式：<code>レベル, 問題, 答え1|答え2|…</code>（カンマ区切り or タブ区切り）。例：</p>
<pre class="list">初級,宇宙で最も多い元素は？,水素|H|Hydrogen|hydrogen
中級,マグマに最も多い元素は？,酸素|O|oxygen
上級,周期表第6周期でメタロイドに分類される元素は？,ポロニウム|Po|polonium</pre>
        <textarea id="bulk" style="width:100%;height:110px;margin-top:8px" placeholder="ここにCSV/TSVを貼り付け"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnImport" class="primary">読み込む</button>
          <button id="btnExport" class="ghost">現在の問題をJSONで保存</button>
          <button id="btnClearAll" class="warn">全問題・進捗を完全初期化</button>
        </div>
      </details>

      <details style="margin-top:12px">
        <summary><b>現在の問題一覧（プレビュー）</b></summary>
        <div id="bankPreview" class="list muted"></div>
      </details>
    </aside>
  </div>

  <div class="footer">
    <b>ヒント：</b>回答は <i>水素</i> / <i>H</i> / <i>hydrogen</i> のように複数表記を登録可能。大文字小文字・全角半角・ひらがな/カタカナ/ローマ字をゆるく判定します。
  </div>
</main>

<script>
/** =======================
 *  問題データ（サンプル）
 *  実運用ではCSV/TSV一括追加で1000問まで拡張できます。
 *  ======================= */
const SAMPLE_BANK = {
  "初級": [
    {
      "q": "水素の元素記号は？",
      "a": [
        "H",
        "水素",
        "hydrogen"
      ]
    },
    {
      "q": "ヘリウムの元素記号は？",
      "a": [
        "He",
        "ヘリウム",
        "helium"
      ]
    },
    {
      "q": "リチウムの元素記号は？",
      "a": [
        "Li",
        "リチウム",
        "lithium"
      ]
    },
    {
      "q": "ベリリウムの元素記号は？",
      "a": [
        "Be",
        "ベリリウム",
        "beryllium"
      ]
    },
    {
      "q": "ホウ素の元素記号は？",
      "a": [
        "B",
        "ホウ素",
        "boron"
      ]
    },
    {
      "q": "炭素の元素記号は？",
      "a": [
        "C",
        "炭素",
        "carbon"
      ]
    },
    {
      "q": "窒素の元素記号は？",
      "a": [
        "N",
        "窒素",
        "nitrogen"
      ]
    },
    {
      "q": "酸素の元素記号は？",
      "a": [
        "O",
        "酸素",
        "oxygen"
      ]
    },
    {
      "q": "フッ素の元素記号は？",
      "a": [
        "F",
        "フッ素",
        "fluorine"
      ]
    },
    {
      "q": "ネオンの元素記号は？",
      "a": [
        "Ne",
        "ネオン",
        "neon"
      ]
    },
    {
      "q": "ナトリウムの元素記号は？",
      "a": [
        "Na",
        "ナトリウム",
        "sodium"
      ]
    },
    {
      "q": "マグネシウムの元素記号は？",
      "a": [
        "Mg",
        "マグネシウム",
        "magnesium"
      ]
    },
    {
      "q": "アルミニウムの元素記号は？",
      "a": [
        "Al",
        "アルミニウム",
        "aluminum"
      ]
    },
    {
      "q": "ケイ素の元素記号は？",
      "a": [
        "Si",
        "ケイ素",
        "silicon"
      ]
    },
    {
      "q": "リンの元素記号は？",
      "a": [
        "P",
        "リン",
        "phosphorus"
      ]
    },
    {
      "q": "硫黄の元素記号は？",
      "a": [
        "S",
        "硫黄",
        "sulfur"
      ]
    },
    {
      "q": "塩素の元素記号は？",
      "a": [
        "Cl",
        "塩素",
        "chlorine"
      ]
    },
    {
      "q": "アルゴンの元素記号は？",
      "a": [
        "Ar",
        "アルゴン",
        "argon"
      ]
    },
    {
      "q": "カリウムの元素記号は？",
      "a": [
        "K",
        "カリウム",
        "potassium"
      ]
    },
    {
      "q": "カルシウムの元素記号は？",
      "a": [
        "Ca",
        "カルシウム",
        "calcium"
      ]
    },
    {
      "q": "スカンジウムの元素記号は？",
      "a": [
        "Sc",
        "スカンジウム",
        "scandium"
      ]
    },
    {
      "q": "チタンの元素記号は？",
      "a": [
        "Ti",
        "チタン",
        "titanium"
      ]
    },
    {
      "q": "バナジウムの元素記号は？",
      "a": [
        "V",
        "バナジウム",
        "vanadium"
      ]
    },
    {
      "q": "クロムの元素記号は？",
      "a": [
        "Cr",
        "クロム",
        "chromium"
      ]
    },
    {
      "q": "マンガンの元素記号は？",
      "a": [
        "Mn",
        "マンガン",
        "manganese"
      ]
    },
    {
      "q": "鉄の元素記号は？",
      "a": [
        "Fe",
        "鉄",
        "iron"
      ]
    },
    {
      "q": "コバルトの元素記号は？",
      "a": [
        "Co",
        "コバルト",
        "cobalt"
      ]
    },
    {
      "q": "ニッケルの元素記号は？",
      "a": [
        "Ni",
        "ニッケル",
        "nickel"
      ]
    },
    {
      "q": "銅の元素記号は？",
      "a": [
        "Cu",
        "銅",
        "copper"
      ]
    },
    {
      "q": "亜鉛の元素記号は？",
      "a": [
        "Zn",
        "亜鉛",
        "zinc"
      ]
    },
    {
      "q": "ガリウムの元素記号は？",
      "a": [
        "Ga",
        "ガリウム",
        "gallium"
      ]
    },
    {
      "q": "ゲルマニウムの元素記号は？",
      "a": [
        "Ge",
        "ゲルマニウム",
        "germanium"
      ]
    },
    {
      "q": "ヒ素の元素記号は？",
      "a": [
        "As",
        "ヒ素",
        "arsenic"
      ]
    },
    {
      "q": "セレンの元素記号は？",
      "a": [
        "Se",
        "セレン",
        "selenium"
      ]
    },
    {
      "q": "臭素の元素記号は？",
      "a": [
        "Br",
        "臭素",
        "bromine"
      ]
    },
    {
      "q": "クリプトンの元素記号は？",
      "a": [
        "Kr",
        "クリプトン",
        "krypton"
      ]
    },
    {
      "q": "元素記号 H は何という元素？",
      "a": [
        "水素",
        "H",
        "hydrogen"
      ]
    },
    {
      "q": "元素記号 He は何という元素？",
      "a": [
        "ヘリウム",
        "He",
        "helium"
      ]
    },
    {
      "q": "元素記号 Li は何という元素？",
      "a": [
        "リチウム",
        "Li",
        "lithium"
      ]
    },
    {
      "q": "元素記号 Be は何という元素？",
      "a": [
        "ベリリウム",
        "Be",
        "beryllium"
      ]
    },
    {
      "q": "元素記号 B は何という元素？",
      "a": [
        "ホウ素",
        "B",
        "boron"
      ]
    },
    {
      "q": "元素記号 C は何という元素？",
      "a": [
        "炭素",
        "C",
        "carbon"
      ]
    },
    {
      "q": "元素記号 N は何という元素？",
      "a": [
        "窒素",
        "N",
        "nitrogen"
      ]
    },
    {
      "q": "元素記号 O は何という元素？",
      "a": [
        "酸素",
        "O",
        "oxygen"
      ]
    },
    {
      "q": "元素記号 F は何という元素？",
      "a": [
        "フッ素",
        "F",
        "fluorine"
      ]
    },
    {
      "q": "元素記号 Ne は何という元素？",
      "a": [
        "ネオン",
        "Ne",
        "neon"
      ]
    },
    {
      "q": "元素記号 Na は何という元素？",
      "a": [
        "ナトリウム",
        "Na",
        "sodium"
      ]
    },
    {
      "q": "元素記号 Mg は何という元素？",
      "a": [
        "マグネシウム",
        "Mg",
        "magnesium"
      ]
    },
    {
      "q": "元素記号 Al は何という元素？",
      "a": [
        "アルミニウム",
        "Al",
        "aluminum"
      ]
    },
    {
      "q": "元素記号 Si は何という元素？",
      "a": [
        "ケイ素",
        "Si",
        "silicon"
      ]
    },
    {
      "q": "元素記号 P は何という元素？",
      "a": [
        "リン",
        "P",
        "phosphorus"
      ]
    },
    {
      "q": "元素記号 S は何という元素？",
      "a": [
        "硫黄",
        "S",
        "sulfur"
      ]
    },
    {
      "q": "元素記号 Cl は何という元素？",
      "a": [
        "塩素",
        "Cl",
        "chlorine"
      ]
    },
    {
      "q": "元素記号 Ar は何という元素？",
      "a": [
        "アルゴン",
        "Ar",
        "argon"
      ]
    },
    {
      "q": "元素記号 K は何という元素？",
      "a": [
        "カリウム",
        "K",
        "potassium"
      ]
    },
    {
      "q": "元素記号 Ca は何という元素？",
      "a": [
        "カルシウム",
        "Ca",
        "calcium"
      ]
    },
    {
      "q": "元素記号 Sc は何という元素？",
      "a": [
        "スカンジウム",
        "Sc",
        "scandium"
      ]
    },
    {
      "q": "元素記号 Ti は何という元素？",
      "a": [
        "チタン",
        "Ti",
        "titanium"
      ]
    },
    {
      "q": "元素記号 V は何という元素？",
      "a": [
        "バナジウム",
        "V",
        "vanadium"
      ]
    },
    {
      "q": "元素記号 Cr は何という元素？",
      "a": [
        "クロム",
        "Cr",
        "chromium"
      ]
    },
    {
      "q": "元素記号 Mn は何という元素？",
      "a": [
        "マンガン",
        "Mn",
        "manganese"
      ]
    },
    {
      "q": "元素記号 Fe は何という元素？",
      "a": [
        "鉄",
        "Fe",
        "iron"
      ]
    },
    {
      "q": "元素記号 Co は何という元素？",
      "a": [
        "コバルト",
        "Co",
        "cobalt"
      ]
    },
    {
      "q": "元素記号 Ni は何という元素？",
      "a": [
        "ニッケル",
        "Ni",
        "nickel"
      ]
    },
    {
      "q": "元素記号 Cu は何という元素？",
      "a": [
        "銅",
        "Cu",
        "copper"
      ]
    },
    {
      "q": "元素記号 Zn は何という元素？",
      "a": [
        "亜鉛",
        "Zn",
        "zinc"
      ]
    },
    {
      "q": "元素記号 Ga は何という元素？",
      "a": [
        "ガリウム",
        "Ga",
        "gallium"
      ]
    },
    {
      "q": "元素記号 Ge は何という元素？",
      "a": [
        "ゲルマニウム",
        "Ge",
        "germanium"
      ]
    },
    {
      "q": "元素記号 As は何という元素？",
      "a": [
        "ヒ素",
        "As",
        "arsenic"
      ]
    },
    {
      "q": "元素記号 Se は何という元素？",
      "a": [
        "セレン",
        "Se",
        "selenium"
      ]
    },
    {
      "q": "元素記号 Br は何という元素？",
      "a": [
        "臭素",
        "Br",
        "bromine"
      ]
    },
    {
      "q": "元素記号 Kr は何という元素？",
      "a": [
        "クリプトン",
        "Kr",
        "krypton"
      ]
    },
    {
      "q": "空気の約78%を占める元素は？",
      "a": [
        "窒素",
        "N",
        "nitrogen"
      ]
    },
    {
      "q": "空気の約21%を占める元素は？",
      "a": [
        "酸素",
        "O",
        "oxygen"
      ]
    },
    {
      "q": "水をつくる元素（酸素以外）は？",
      "a": [
        "水素",
        "H",
        "hydrogen"
      ]
    },
    {
      "q": "食塩をつくる金属元素は？",
      "a": [
        "ナトリウム",
        "Na",
        "sodium"
      ]
    },
    {
      "q": "食塩をつくる非金属元素は？",
      "a": [
        "塩素",
        "Cl",
        "chlorine"
      ]
    },
    {
      "q": "半導体として代表的な元素は？",
      "a": [
        "ケイ素",
        "Si",
        "silicon"
      ]
    },
    {
      "q": "広告看板や照明に用いられる不活性ガスは？",
      "a": [
        "ネオン",
        "Ne",
        "アルゴン",
        "Ar",
        "クリプトン",
        "Kr"
      ]
    },
    {
      "q": "骨や歯に多い金属元素は？",
      "a": [
        "カルシウム",
        "Ca",
        "calcium"
      ]
    },
    {
      "q": "赤血球のヘモグロビンに必須の金属元素は？",
      "a": [
        "鉄",
        "Fe",
        "iron"
      ]
    },
    {
      "q": "電気をよく通す金属元素を一つ",
      "a": [
        "銅",
        "Cu"
      ]
    },
    {
      "q": "軽くて錆びにくい金属（軽金属）を一つ",
      "a": [
        "アルミニウム",
        "Al",
        "マグネシウム",
        "Mg"
      ]
    },
    {
      "q": "家庭のガラス（ソーダ石灰ガラス）に含まれる元素を一つ",
      "a": [
        "ケイ素",
        "Si",
        "ナトリウム",
        "Na",
        "カルシウム",
        "Ca"
      ]
    },
    {
      "q": "乾電池の黒鉛棒に使われる元素は？",
      "a": [
        "炭素",
        "C",
        "carbon"
      ]
    },
    {
      "q": "漂白剤（次亜塩素酸）に関わる元素は？",
      "a": [
        "塩素",
        "Cl"
      ]
    },
    {
      "q": "歯磨き粉のむし歯予防に使われる元素（陰イオン形）",
      "a": [
        "フッ素",
        "F",
        "Cl-"
      ]
    },
    {
      "q": "石英の主成分元素の一つは？",
      "a": [
        "ケイ素",
        "Si",
        "酸素",
        "O"
      ]
    },
    {
      "q": "玄武岩に多い二価の金属元素を一つ",
      "a": [
        "マグネシウム",
        "Mg",
        "鉄",
        "Fe",
        "カルシウム",
        "Ca"
      ]
    },
    {
      "q": "常温で液体の元素（範囲内）を一つ",
      "a": [
        "臭素",
        "Br",
        "bromine"
      ]
    },
    {
      "q": "不活性ガス（貴ガス）を一つ",
      "a": [
        "ヘリウム",
        "He",
        "ネオン",
        "Ne",
        "アルゴン",
        "Ar",
        "クリプトン",
        "Kr"
      ]
    },
    {
      "q": "アルカリ金属を一つ",
      "a": [
        "リチウム",
        "ナトリウム",
        "カリウム"
      ]
    },
    {
      "q": "1番の元素は？",
      "a": [
        "水素",
        "H",
        "hydrogen"
      ]
    },
    {
      "q": "2番の元素は？",
      "a": [
        "ヘリウム",
        "He",
        "helium"
      ]
    },
    {
      "q": "3番の元素は？",
      "a": [
        "リチウム",
        "Li",
        "lithium"
      ]
    },
    {
      "q": "4番の元素は？",
      "a": [
        "ベリリウム",
        "Be",
        "beryllium"
      ]
    },
    {
      "q": "5番の元素は？",
      "a": [
        "ホウ素",
        "B",
        "boron"
      ]
    },
    {
      "q": "6番の元素は？",
      "a": [
        "炭素",
        "C",
        "carbon"
      ]
    },
    {
      "q": "7番の元素は？",
      "a": [
        "窒素",
        "N",
        "nitrogen"
      ]
    },
    {
      "q": "8番の元素は？",
      "a": [
        "酸素",
        "O",
        "oxygen"
      ]
    }
  ],
  "中級": [
    {
      "q": "アルカリ金属を一つ挙げよ。",
      "a": [
        "リチウム",
        "ナトリウム",
        "カリウム"
      ]
    },
    {
      "q": "アルカリ土類金属を一つ挙げよ。",
      "a": [
        "ベリリウム",
        "マグネシウム",
        "カルシウム"
      ]
    },
    {
      "q": "ハロゲン元素を一つ挙げよ。",
      "a": [
        "フッ素",
        "塩素",
        "臭素"
      ]
    },
    {
      "q": "貴ガス（不活性ガス）を一つ挙げよ。",
      "a": [
        "ヘリウム",
        "ネオン",
        "アルゴン",
        "クリプトン"
      ]
    },
    {
      "q": "遷移金属を一つ挙げよ。",
      "a": [
        "スカンジウム",
        "チタン",
        "バナジウム",
        "クロム",
        "マンガン",
        "鉄",
        "コバルト",
        "ニッケル",
        "銅",
        "亜鉛"
      ]
    },
    {
      "q": "半金属（メタロイド）を一つ挙げよ。",
      "a": [
        "ホウ素",
        "ケイ素",
        "ゲルマニウム",
        "ヒ素"
      ]
    },
    {
      "q": "アルカリ金属を一つ挙げよ。",
      "a": [
        "リチウム",
        "ナトリウム",
        "カリウム"
      ]
    },
    {
      "q": "アルカリ土類金属を一つ挙げよ。",
      "a": [
        "ベリリウム",
        "マグネシウム",
        "カルシウム"
      ]
    },
    {
      "q": "ハロゲン元素を一つ挙げよ。",
      "a": [
        "フッ素",
        "塩素",
        "臭素"
      ]
    },
    {
      "q": "貴ガス（不活性ガス）を一つ挙げよ。",
      "a": [
        "ヘリウム",
        "ネオン",
        "アルゴン",
        "クリプトン"
      ]
    },
    {
      "q": "遷移金属を一つ挙げよ。",
      "a": [
        "スカンジウム",
        "チタン",
        "バナジウム",
        "クロム",
        "マンガン",
        "鉄",
        "コバルト",
        "ニッケル",
        "銅",
        "亜鉛"
      ]
    },
    {
      "q": "半金属（メタロイド）を一つ挙げよ。",
      "a": [
        "ホウ素",
        "ケイ素",
        "ゲルマニウム",
        "ヒ素"
      ]
    },
    {
      "q": "半導体素子（Si系）で中心となる元素は？",
      "a": [
        "ケイ素",
        "Si",
        "silicon"
      ]
    },
    {
      "q": "青色LED関連で重要な元素を一つ（In, Ga, N）",
      "a": [
        "ガリウム",
        "Ga",
        "窒素",
        "N"
      ]
    },
    {
      "q": "ステンレス鋼に含まれる遷移金属を一つ（Cr, Ni, Fe）",
      "a": [
        "クロム",
        "Cr",
        "ニッケル",
        "Ni",
        "鉄",
        "Fe"
      ]
    },
    {
      "q": "電池材料に使われるアルカリ金属は？",
      "a": [
        "リチウム",
        "Li"
      ]
    },
    {
      "q": "ガラス（SiO2）に必須の元素を一つ",
      "a": [
        "ケイ素",
        "Si",
        "酸素",
        "O"
      ]
    },
    {
      "q": "骨格筋や神経伝達で重要な1価金属イオンの元素を一つ（Na, K）",
      "a": [
        "ナトリウム",
        "Na",
        "カリウム",
        "K"
      ]
    },
    {
      "q": "血液の赤い色に関わる金属元素は？",
      "a": [
        "鉄",
        "Fe"
      ]
    },
    {
      "q": "時計のめっきや耐食用途で用いられる遷移金属を一つ（Ni, Cr）",
      "a": [
        "ニッケル",
        "Ni",
        "クロム",
        "Cr"
      ]
    },
    {
      "q": "乾電池の正極材料に関わる遷移金属を一つ（Mn, Zn）",
      "a": [
        "マンガン",
        "Mn",
        "亜鉛",
        "Zn"
      ]
    },
    {
      "q": "合金\"黄銅\"の主成分元素を一つ（Cu, Zn）",
      "a": [
        "銅",
        "Cu",
        "亜鉛",
        "Zn"
      ]
    },
    {
      "q": "ガリウムの元素記号は？",
      "a": [
        "Ga",
        "ガリウム",
        "gallium"
      ]
    },
    {
      "q": "ゲルマニウムの元素記号は？",
      "a": [
        "Ge",
        "ゲルマニウム",
        "germanium"
      ]
    },
    {
      "q": "常温で液体の元素（範囲内）",
      "a": [
        "臭素",
        "Br",
        "bromine"
      ]
    },
    {
      "q": "空気中に約1%含まれる不活性ガスは？",
      "a": [
        "アルゴン",
        "Ar",
        "argon"
      ]
    },
    {
      "q": "緑色の炎色反応を示すハロゲン化物に関連が深い金属元素（Cu）",
      "a": [
        "銅",
        "Cu",
        "copper"
      ]
    },
    {
      "q": "半導体ドーピングでn型に使われる元素を一つ（P, As, Sb）",
      "a": [
        "リン",
        "P",
        "ヒ素",
        "As"
      ]
    },
    {
      "q": "半導体ドーピングでp型に使われる元素を一つ（B, Ga, In）",
      "a": [
        "ホウ素",
        "B",
        "ガリウム",
        "Ga"
      ]
    },
    {
      "q": "硬い合金や工具鋼で使われる元素を一つ（V, Cr, Mn）",
      "a": [
        "バナジウム",
        "V",
        "クロム",
        "Cr",
        "マンガン",
        "Mn"
      ]
    },
    {
      "q": "ナトリウムの元素記号は？",
      "a": [
        "Na",
        "ナトリウム",
        "sodium"
      ]
    },
    {
      "q": "マグネシウムの元素記号は？",
      "a": [
        "Mg",
        "マグネシウム",
        "magnesium"
      ]
    },
    {
      "q": "アルミニウムの元素記号は？",
      "a": [
        "Al",
        "アルミニウム",
        "aluminum"
      ]
    },
    {
      "q": "ケイ素の元素記号は？",
      "a": [
        "Si",
        "ケイ素",
        "silicon"
      ]
    },
    {
      "q": "リンの元素記号は？",
      "a": [
        "P",
        "リン",
        "phosphorus"
      ]
    },
    {
      "q": "硫黄の元素記号は？",
      "a": [
        "S",
        "硫黄",
        "sulfur"
      ]
    },
    {
      "q": "塩素の元素記号は？",
      "a": [
        "Cl",
        "塩素",
        "chlorine"
      ]
    },
    {
      "q": "アルゴンの元素記号は？",
      "a": [
        "Ar",
        "アルゴン",
        "argon"
      ]
    },
    {
      "q": "カリウムの元素記号は？",
      "a": [
        "K",
        "カリウム",
        "potassium"
      ]
    },
    {
      "q": "カルシウムの元素記号は？",
      "a": [
        "Ca",
        "カルシウム",
        "calcium"
      ]
    },
    {
      "q": "スカンジウムの元素記号は？",
      "a": [
        "Sc",
        "スカンジウム",
        "scandium"
      ]
    },
    {
      "q": "チタンの元素記号は？",
      "a": [
        "Ti",
        "チタン",
        "titanium"
      ]
    },
    {
      "q": "バナジウムの元素記号は？",
      "a": [
        "V",
        "バナジウム",
        "vanadium"
      ]
    },
    {
      "q": "クロムの元素記号は？",
      "a": [
        "Cr",
        "クロム",
        "chromium"
      ]
    },
    {
      "q": "マンガンの元素記号は？",
      "a": [
        "Mn",
        "マンガン",
        "manganese"
      ]
    },
    {
      "q": "鉄の元素記号は？",
      "a": [
        "Fe",
        "鉄",
        "iron"
      ]
    },
    {
      "q": "コバルトの元素記号は？",
      "a": [
        "Co",
        "コバルト",
        "cobalt"
      ]
    },
    {
      "q": "ニッケルの元素記号は？",
      "a": [
        "Ni",
        "ニッケル",
        "nickel"
      ]
    },
    {
      "q": "銅の元素記号は？",
      "a": [
        "Cu",
        "銅",
        "copper"
      ]
    },
    {
      "q": "亜鉛の元素記号は？",
      "a": [
        "Zn",
        "亜鉛",
        "zinc"
      ]
    }
  ],
  "上級": [
    {
      "q": "常温で液体の元素（この範囲で該当するもの）",
      "a": [
        "臭素",
        "Br",
        "bromine"
      ]
    },
    {
      "q": "メタロイドに分類される元素を一つ",
      "a": [
        "ホウ素",
        "ケイ素",
        "ゲルマニウム",
        "ヒ素"
      ]
    },
    {
      "q": "アルカリ金属のうち原子番号が最も大きい（範囲内）元素は？",
      "a": [
        "カリウム",
        "K"
      ]
    },
    {
      "q": "18族元素で最も重い（範囲内）元素は？",
      "a": [
        "クリプトン",
        "Kr"
      ]
    },
    {
      "q": "遷移金属の最初の元素は？（Z=21）",
      "a": [
        "スカンジウム",
        "Sc",
        "scandium"
      ]
    },
    {
      "q": "pブロックに属する元素を一つ（範囲内）",
      "a": [
        "ホウ素",
        "B",
        "炭素",
        "C",
        "窒素",
        "N",
        "酸素",
        "O",
        "フッ素",
        "F",
        "ネオン",
        "Ne",
        "アルミニウム",
        "Al",
        "ケイ素",
        "Si",
        "リン",
        "P",
        "硫黄",
        "S",
        "塩素",
        "Cl",
        "アルゴン",
        "Ar",
        "ガリウム",
        "Ga",
        "ゲルマニウム",
        "Ge",
        "ヒ素",
        "As",
        "セレン",
        "Se",
        "臭素",
        "Br",
        "クリプトン",
        "Kr"
      ]
    },
    {
      "q": "dブロックに属する元素を一つ（範囲内）",
      "a": [
        "スカンジウム",
        "チタン",
        "バナジウム",
        "クロム",
        "マンガン",
        "鉄",
        "コバルト",
        "ニッケル",
        "銅",
        "亜鉛"
      ]
    },
    {
      "q": "地殻に豊富な金属元素（範囲内）を一つ",
      "a": [
        "アルミニウム",
        "Al",
        "鉄",
        "Fe",
        "カルシウム",
        "Ca",
        "ナトリウム",
        "Na",
        "カリウム",
        "K",
        "マグネシウム",
        "Mg"
      ]
    },
    {
      "q": "硫化鉱物に多く含まれる元素を一つ（S, Fe, Cu, Znなど）",
      "a": [
        "硫黄",
        "S",
        "鉄",
        "Fe",
        "銅",
        "Cu",
        "亜鉛",
        "Zn"
      ]
    },
    {
      "q": "酸素族元素（カルコゲン）を一つ（範囲内）",
      "a": [
        "酸素",
        "O",
        "硫黄",
        "S",
        "セレン",
        "Se"
      ]
    },
    {
      "q": "スカンジウムの元素記号は？",
      "a": [
        "Sc",
        "スカンジウム",
        "scandium"
      ]
    },
    {
      "q": "元素記号 Sc は何という元素？",
      "a": [
        "スカンジウム",
        "Sc",
        "scandium"
      ]
    },
    {
      "q": "チタンの元素記号は？",
      "a": [
        "Ti",
        "チタン",
        "titanium"
      ]
    },
    {
      "q": "元素記号 Ti は何という元素？",
      "a": [
        "チタン",
        "Ti",
        "titanium"
      ]
    },
    {
      "q": "バナジウムの元素記号は？",
      "a": [
        "V",
        "バナジウム",
        "vanadium"
      ]
    },
    {
      "q": "元素記号 V は何という元素？",
      "a": [
        "バナジウム",
        "V",
        "vanadium"
      ]
    },
    {
      "q": "クロムの元素記号は？",
      "a": [
        "Cr",
        "クロム",
        "chromium"
      ]
    },
    {
      "q": "元素記号 Cr は何という元素？",
      "a": [
        "クロム",
        "Cr",
        "chromium"
      ]
    },
    {
      "q": "マンガンの元素記号は？",
      "a": [
        "Mn",
        "マンガン",
        "manganese"
      ]
    },
    {
      "q": "元素記号 Mn は何という元素？",
      "a": [
        "マンガン",
        "Mn",
        "manganese"
      ]
    },
    {
      "q": "鉄の元素記号は？",
      "a": [
        "Fe",
        "鉄",
        "iron"
      ]
    },
    {
      "q": "元素記号 Fe は何という元素？",
      "a": [
        "鉄",
        "Fe",
        "iron"
      ]
    },
    {
      "q": "コバルトの元素記号は？",
      "a": [
        "Co",
        "コバルト",
        "cobalt"
      ]
    },
    {
      "q": "元素記号 Co は何という元素？",
      "a": [
        "コバルト",
        "Co",
        "cobalt"
      ]
    },
    {
      "q": "ニッケルの元素記号は？",
      "a": [
        "Ni",
        "ニッケル",
        "nickel"
      ]
    },
    {
      "q": "元素記号 Ni は何という元素？",
      "a": [
        "ニッケル",
        "Ni",
        "nickel"
      ]
    },
    {
      "q": "銅の元素記号は？",
      "a": [
        "Cu",
        "銅",
        "copper"
      ]
    },
    {
      "q": "元素記号 Cu は何という元素？",
      "a": [
        "銅",
        "Cu",
        "copper"
      ]
    },
    {
      "q": "亜鉛の元素記号は？",
      "a": [
        "Zn",
        "亜鉛",
        "zinc"
      ]
    },
    {
      "q": "元素記号 Zn は何という元素？",
      "a": [
        "亜鉛",
        "Zn",
        "zinc"
      ]
    }
  ]
};

// ----------- ユーティリティ（正規化） -----------
const kanaMap = { // 片仮名→平仮名
  'ァ':'ぁ','ィ':'ぃ','ゥ':'ぅ','ェ':'ぇ','ォ':'ぉ','ッ':'っ','ャ':'ゃ','ュ':'ゅ','ョ':'ょ','ヮ':'ゎ','ヵ':'か','ヶ':'け'
};
function toHiragana(str){
  return str.replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0)-0x60))
            .replace(/[ヷヸヹヺ]/g, s => s) // 例外はそのまま
            .replace(/[ャュョァィゥェォッヮヵヶ]/g, s => kanaMap[s]||s);
}
function normalize(s){
  if(!s) return "";
  // 全角→半角（英数のみ）、トリム
  s = s.trim()
       .replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
       .toLowerCase();
  // 長音など削除、スペース詰め
  s = s.replace(/[‐‑–—―ー]/g,"-").replace(/\s+/g," ");
  // ひらがな正規化（カタカナ→ひらがな）
  s = toHiragana(s);
  return s;
}
function anyMatch(input, answers){
  const x = normalize(input);
  return answers.some(ans => normalize(ans) === x);
}

// ----------- ストレージ -----------
const KEY_BANK = "element_quiz_bank_v1";
const KEY_STATE_PREFIX = "element_quiz_state_";
function loadBank(){
  const saved = localStorage.getItem(KEY_BANK);
  if(saved){
    try { return JSON.parse(saved); } catch(e){ console.warn(e); }
  }
  return structuredClone(SAMPLE_BANK);
}
function saveBank(){
  localStorage.setItem(KEY_BANK, JSON.stringify(BANK));
}
function loadState(level){
  const raw = localStorage.getItem(KEY_STATE_PREFIX+level);
  if(!raw) return {shown:0,correct:0,order:[],cursor:0,seen:{}};
  try{ return JSON.parse(raw); }catch{ return {shown:0,correct:0,order:[],cursor:0,seen:{}}; }
}
function saveState(level){
  localStorage.setItem(KEY_STATE_PREFIX+level, JSON.stringify(STATE[level]));
}
function resetState(level){
  STATE[level] = {shown:0,correct:0,order:shuffle([...Array(BANK[level].length).keys()]),cursor:0,seen:{}};
  saveState(level);
}

// ----------- シャッフル -----------
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

// ----------- DOM -----------
const levelsEl = document.getElementById("levels");
const qEl = document.getElementById("question");
const ansEl = document.getElementById("answer");
const resEl = document.getElementById("result");
const shownEl = document.getElementById("shown");
const correctEl = document.getElementById("correct");
const rateEl = document.getElementById("rate");
const leftpill = document.getElementById("leftpill");
const progbar = document.getElementById("progbar");
const previewEl = document.getElementById("bankPreview");
const bulkEl = document.getElementById("bulk");
const btnStart = document.getElementById("btnStart");
const btnSubmit = document.getElementById("btnSubmit");
const btnReveal = document.getElementById("btnReveal");
const btnNext = document.getElementById("btnNext");
const btnPass = document.getElementById("btnPass");
const btnReset = document.getElementById("btnReset");
const btnImport = document.getElementById("btnImport");
const btnExport = document.getElementById("btnExport");
const btnClearAll = document.getElementById("btnClearAll");

// ----------- 初期化 -----------
let BANK = loadBank();
let LEVELS = Object.keys(BANK);
let STATE = {}; // per level
LEVELS.forEach(lv => { STATE[lv] = loadState(lv); if(!STATE[lv].order || STATE[lv].order.length !== BANK[lv].length){ resetState(lv); } });

// レベルUI
let currentLevel = LEVELS[0] || "初級";
function renderLevels(){
  levelsEl.innerHTML = "";
  LEVELS.forEach(lv=>{
    const btn = document.createElement("button");
    btn.className = "lv-btn" + (lv===currentLevel ? " active": "");
    btn.textContent = lv;
    btn.onclick = ()=>{ currentLevel=lv; document.querySelectorAll(".lv-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); updateStats(); qEl.textContent = "「出題開始」を押してください。"; disablePlay(true); resEl.textContent=""; };
    levelsEl.appendChild(btn);
  });
}
renderLevels();
updatePreview();
updateStats();
disablePlay(true);

// ----------- 出題ロジック -----------
let currentIndex = null; // 問題インデックス（BANK[currentLevel]内）
function start(){
  ensureOrder();
  disablePlay(false);
  next();
}
function ensureOrder(){
  const L = BANK[currentLevel].length;
  const st = STATE[currentLevel];
  // 長さが変わったら再シャッフル
  if(!st.order || st.order.length!==L){
    resetState(currentLevel);
  }
}
function next(){
  const st = STATE[currentLevel];
  ensureOrder();
  if(st.cursor>=st.order.length){
    qEl.textContent = "このレベルの全問題を解きました！「このレベルをリセット」で再挑戦できます。";
    disablePlay(true);
    return;
  }
  currentIndex = st.order[st.cursor];
  const item = BANK[currentLevel][currentIndex];
  qEl.textContent = item.q;
  ansEl.value = ""; ansEl.focus();
  resEl.textContent = "";
  btnReveal.disabled=false;
  btnNext.disabled=true;
  btnPass.disabled=false;
}
function submit(){
  if(currentIndex===null) return;
  const item = BANK[currentLevel][currentIndex];
  const ok = anyMatch(ansEl.value, item.a||[]);
  const st = STATE[currentLevel];
  if(!(currentIndex in st.seen)){ st.seen[currentIndex]=true; st.shown++; }
  if(ok){ st.correct++; resEl.textContent = "正解！"; resEl.className = "result ok"; btnNext.disabled=false; btnPass.disabled=true; }
  else { resEl.textContent = "不正解…"; resEl.className = "result ng"; }
  updateStats();
  if(ok){ st.cursor++; saveState(currentLevel); }
}
function passQ(){
  const st=STATE[currentLevel];
  if(!(currentIndex in st.seen)){ st.seen[currentIndex]=true; st.shown++; }
  st.cursor++; saveState(currentLevel);
  updateStats();
  next();
}
function reveal(){
  if(currentIndex===null) return;
  const item = BANK[currentLevel][currentIndex];
  resEl.innerHTML = "答え例：<b>"+ (item.a||[]).join("</b> / <b>") + "</b>";
  resEl.className = "result";
  btnNext.disabled=false;
  btnPass.disabled=true;
}

// ----------- 表示/統計 -----------
function updateStats(){
  const st = STATE[currentLevel];
  shownEl.textContent = st.shown;
  correctEl.textContent = st.correct;
  const rate = st.shown ? Math.round(st.correct/st.shown*100) : 0;
  rateEl.textContent = rate + "%";
  const left = Math.max(0, (BANK[currentLevel].length - st.cursor));
  leftpill.textContent = "残り："+left;
  const p = BANK[currentLevel].length ? Math.round(st.cursor/BANK[currentLevel].length*100) : 0;
  progbar.style.width = p + "%";
}
function disablePlay(disabled){
  ansEl.disabled = disabled;
  btnSubmit.disabled = disabled;
  btnReveal.disabled = disabled;
  btnNext.disabled = disabled;
  btnPass.disabled = disabled;
}

// ----------- 取込/書出/初期化 -----------
function parseBulk(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  const added = [];
  for(const line of lines){
    // CSV or TSV
    const parts = line.split(/\t|,(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)/); // タブ or カンマ（簡易）
    if(parts.length<3) continue;
    const lv = parts[0].trim() || "初級";
    const q = parts[1].trim();
    const a = parts.slice(2).join(",").split("|").map(s=>s.trim()).filter(Boolean);
    if(!BANK[lv]) BANK[lv]=[];
    BANK[lv].push({q,a});
    added.push({lv,q,a});
  }
  // レベルと状態更新
  LEVELS = Object.keys(BANK);
  LEVELS.forEach(lv=>{ if(!STATE[lv]) resetState(lv); else { // 長さ変化に対応
    if(STATE[lv].order.length!==BANK[lv].length){ resetState(lv); }
  }});
  saveBank();
  renderLevels();
  updatePreview();
  return added.length;
}
function updatePreview(){
  let html = "";
  for(const lv of Object.keys(BANK)){
    html += `<div><b>${lv}</b>（${BANK[lv].length}件）</div>`;
    BANK[lv].slice(0,10).forEach((it,i)=>{
      html += `<div>・${escapeHtml(it.q)} <span class="muted">[${(it.a||[]).join(" / ")}]</span></div>`;
    });
    if(BANK[lv].length>10){ html += `<div class="muted">…ほか ${BANK[lv].length-10}件</div>`; }
    html += "<hr />";
  }
  previewEl.innerHTML = html || "<i>まだ問題がありません。</i>";
}
function exportJSON(){
  const blob = new Blob([JSON.stringify(BANK,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "elements_quiz_bank.json";
  a.click();
  URL.revokeObjectURL(url);
}
function clearAll(){
  if(!confirm("全問題と進捗を完全に消去します。よろしいですか？")) return;
  localStorage.removeItem(KEY_BANK);
  Object.keys(localStorage).forEach(k=>{ if(k.startsWith(KEY_STATE_PREFIX)) localStorage.removeItem(k); });
  BANK = structuredClone(SAMPLE_BANK);
  LEVELS = Object.keys(BANK);
  STATE = {};
  LEVELS.forEach(lv=> resetState(lv));
  currentLevel = LEVELS[0];
  renderLevels(); updatePreview(); updateStats(); qEl.textContent="初期化しました。レベルを選び「出題開始」を押してください。"; disablePlay(true);
}

// ----------- 小物 -----------
function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// ----------- イベント -----------
btnStart.addEventListener("click", start);
btnSubmit.addEventListener("click", submit);
btnReveal.addEventListener("click", reveal);
btnNext.addEventListener("click", ()=>{ const st=STATE[currentLevel]; st.cursor++; saveState(currentLevel); updateStats(); next(); });
btnPass.addEventListener("click", passQ);
btnReset.addEventListener("click", ()=>{ if(confirm("このレベルの進捗をリセットしますか？")){ resetState(currentLevel); updateStats(); next(); }});
btnImport.addEventListener("click", ()=>{
  const n = parseBulk(bulkEl.value);
  alert(n+"件を追加しました。");
  bulkEl.value="";
});
btnExport.addEventListener("click", exportJSON);
btnClearAll.addEventListener("click", clearAll);

ansEl.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.ctrlKey){ e.preventDefault(); submit(); }
  else if(e.key==="Enter" && e.ctrlKey){ e.preventDefault(); const st=STATE[currentLevel]; st.cursor++; saveState(currentLevel); updateStats(); next(); }
  else if(e.key==="Escape"){ e.preventDefault(); passQ(); }
});

// 初回フォーカス
document.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && btnStart){ /* noop */ }});
</script>
</body>
</html>
